#!/bin/bash

# ============================================
# ุณูุฑูุจุช ุงููุณุฎ ุงูุงุญุชูุงุทู ุงููุงูู
# ============================================
# ุงููุฏู: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ ูุจู ุฃู ุชุนุฏููุงุช
# ุงูุฃูุงู: ุขูู - ููุดุฆ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุท
# ============================================

echo "================================================"
echo "ุจุฏุก ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู"
echo "ุงูุชุงุฑูุฎ: $(date)"
echo "================================================"
echo ""

# ุงููุชุบูุฑุงุช (ุนุฏูููุง ุญุณุจ ุจูุฆุชู)
DB_HOST="${DB_HOST:-localhost}"
DB_PORT="${DB_PORT:-5432}"
DB_NAME="${DB_NAME:-postgres}"
DB_USER="${DB_USER:-postgres}"
BACKUP_DIR="./backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/backup_pre_migration_${TIMESTAMP}.sql"

# ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
mkdir -p "$BACKUP_DIR"

echo "๐ฆ ูุนูููุงุช ุงููุณุฎ ุงูุงุญุชูุงุทู:"
echo "   ุงููุถูู: $DB_HOST"
echo "   ุงููููุฐ: $DB_PORT"
echo "   ูุงุนุฏุฉ ุงูุจูุงูุงุช: $DB_NAME"
echo "   ุงููุณุชุฎุฏู: $DB_USER"
echo "   ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $BACKUP_FILE"
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ pg_dump
if ! command -v pg_dump &> /dev/null; then
    echo "โ ุฎุทุฃ: pg_dump ุบูุฑ ููุฌูุฏ"
    echo "   ูุฑุฌู ุชุซุจูุช PostgreSQL client tools"
    exit 1
fi

echo "๐ ุฌุงุฑู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ..."
echo ""

# ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
pg_dump \
  -h "$DB_HOST" \
  -p "$DB_PORT" \
  -U "$DB_USER" \
  -d "$DB_NAME" \
  --format=plain \
  --no-owner \
  --no-acl \
  --verbose \
  --file="$BACKUP_FILE" \
  2>&1

# ุงูุชุญูู ูู ูุฌุงุญ ุงูุนูููุฉ
if [ $? -eq 0 ]; then
    BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo ""
    echo "================================================"
    echo "โ ุชูุช ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุจูุฌุงุญ"
    echo "================================================"
    echo "   ุงูููู: $BACKUP_FILE"
    echo "   ุงูุญุฌู: $BACKUP_SIZE"
    echo "   ุงูุชุงุฑูุฎ: $(date)"
    echo "================================================"
    echo ""
    echo "๐ ููุงุญุธุงุช ูููุฉ:"
    echo "   1. ุงุญูุธ ูุฐุง ุงูููู ูู ููุงู ุขูู"
    echo "   2. ูุง ุชุญุฐู ูุฐุง ุงูููู ุญุชู ุชุชุฃูุฏ ูู ูุฌุงุญ ุฌููุน ุงููุฑุงุญู"
    echo "   3. ููููู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุจุงุณุชุฎุฏุงู:"
    echo "      psql -h $DB_HOST -U $DB_USER -d $DB_NAME < $BACKUP_FILE"
    echo ""
    
    # ุฅูุดุงุก ููู ูุนูููุงุช
    INFO_FILE="${BACKUP_FILE}.info"
    cat > "$INFO_FILE" << EOF
ุชุงุฑูุฎ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $(date)
ุงููุถูู: $DB_HOST
ูุงุนุฏุฉ ุงูุจูุงูุงุช: $DB_NAME
ุงููุณุชุฎุฏู: $DB_USER
ุญุฌู ุงูููู: $BACKUP_SIZE
ุงูุญุงูุฉ: ูุฌุญ

ููุงุญุธุงุช:
- ูุฐู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุจุฏุก ุนูููุฉ ุชุญุณูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูููุตุญ ุจุญูุธูุง ูู ููุงู ุขูู ุฎุงุฑุฌ ุงูุฎุงุฏู
- ูุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ: psql -h $DB_HOST -U $DB_USER -d $DB_NAME < $BACKUP_FILE
EOF
    
    echo "๐ ุชู ุฅูุดุงุก ููู ุงููุนูููุงุช: $INFO_FILE"
    echo ""
    
    # ุญุณุงุจ checksum ููุชุญูู ูู ุณูุงูุฉ ุงูููู
    if command -v sha256sum &> /dev/null; then
        CHECKSUM=$(sha256sum "$BACKUP_FILE" | cut -d' ' -f1)
        echo "$CHECKSUM  $BACKUP_FILE" > "${BACKUP_FILE}.sha256"
        echo "๐ ุชู ุฅูุดุงุก checksum: ${BACKUP_FILE}.sha256"
        echo "   SHA256: $CHECKSUM"
        echo ""
    fi
    
    exit 0
else
    echo ""
    echo "================================================"
    echo "โ ูุดูุช ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู"
    echo "================================================"
    echo "   ูุฑุฌู ุงูุชุญูู ูู:"
    echo "   1. ุตูุงุญูุงุช ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช"
    echo "   2. ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ"
    echo "   3. ุงุณู ูุงุนุฏุฉ ุงูุจูุงูุงุช"
    echo "   4. ุงููุณุงุญุฉ ุงููุชููุฑุฉ ุนูู ุงููุฑุต"
    echo "================================================"
    echo ""
    exit 1
fi
