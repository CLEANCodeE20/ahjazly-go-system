-- SECURITY FIX: STRICT DATA ISOLATION
-- Date: 2026-01-08
-- Description: Separates access logic for "Public Operational Data" (Trips, Routes) 
-- vs "Private Financial/Internal Data" (Commissions, Ledger, Staff).

BEGIN;

-- 1. Helper for Admin check (MUST BE FIRST)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.user_roles 
    WHERE user_id = auth.uid() AND role = 'admin'
  );
$$;

-- 2. Create a STRICT access function for Internal/Private Data
CREATE OR REPLACE FUNCTION public.can_access_private_data(_target_partner_id BIGINT)
RETURNS BOOLEAN
LANGUAGE plpgsql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
    _user_id UUID := auth.uid();
    _role TEXT;
    _user_partner_id INTEGER;
BEGIN
    -- Deny Anonymous
    IF _user_id IS NULL THEN
        RETURN FALSE;
    END IF;

    -- Get Role
    SELECT role::text, partner_id INTO _role, _user_partner_id 
    FROM public.user_roles 
    WHERE user_id = _user_id 
    LIMIT 1;

    -- Deny if no role (Regular Customer)
    IF _role IS NULL THEN
        RETURN FALSE;
    END IF;

    -- Allow Admin
    IF _role = 'admin' THEN
        RETURN TRUE;
    END IF;

    -- Allow Partner/Employee if IDs match
    IF _target_partner_id IS NULL THEN
        RETURN FALSE; 
    END IF;

    RETURN _target_partner_id = _user_partner_id;
END;
$$;

-- 3. Apply Strict Policy to SENSITIVE/PRIVATE Tables
DO $$ 
DECLARE 
    t TEXT;
    partner_id_tables TEXT[] := ARRAY[
        'commissions', 
        'booking_ledger', 
        'partner_invoices', 
        'partner_payments',
        'employees',
        'drivers'
    ];
BEGIN
    FOREACH t IN ARRAY partner_id_tables LOOP
        EXECUTE format('DROP POLICY IF EXISTS "Unified view access for %I" ON public.%I', t, t);
        EXECUTE format('DROP POLICY IF EXISTS "Public read access for %I" ON public.%I', t, t);
        EXECUTE format('DROP POLICY IF EXISTS "Partners/Employees view own company" ON public.%I', t);
        EXECUTE format('DROP POLICY IF EXISTS "Strict private access for %I" ON public.%I', t, t);
        
        EXECUTE format('CREATE POLICY "Strict private access for %I" ON public.%I FOR SELECT USING (public.can_access_private_data(partner_id))', t, t);
    END LOOP;
END $$;

-- 4. Individual Policies for tables WITHOUT direct partner_id column

-- Daily Commissions (Admin Only)
DROP POLICY IF EXISTS "Strict private access for daily_commissions" ON public.daily_commissions;
DROP POLICY IF EXISTS "Read access for daily_commissions" ON public.daily_commissions;
CREATE POLICY "Strict private access for daily_commissions" ON public.daily_commissions 
FOR SELECT USING (public.is_admin());

-- Partner Invoice Items (Join via invoice)
DROP POLICY IF EXISTS "Strict private access for partner_invoice_items" ON public.partner_invoice_items;
DROP POLICY IF EXISTS "Read access for partner_invoice_items" ON public.partner_invoice_items;
CREATE POLICY "Strict private access for partner_invoice_items" ON public.partner_invoice_items 
FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM public.partner_invoices i 
        WHERE i.invoice_id = public.partner_invoice_items.invoice_id 
        AND public.can_access_private_data(i.partner_id)
    )
);

-- Booking Approvals (Join via booking -> trip)
DROP POLICY IF EXISTS "Strict private access for booking_approvals" ON public.booking_approvals;
DROP POLICY IF EXISTS "Read access for booking_approvals" ON public.booking_approvals;
CREATE POLICY "Strict private access for booking_approvals" ON public.booking_approvals 
FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM public.bookings b
        JOIN public.trips t ON t.trip_id = b.trip_id
        WHERE b.booking_id = public.booking_approvals.booking_id 
        AND public.can_access_private_data(t.partner_id)
    )
);

-- 5. Fix BOOKINGS Table (Hybrid)
DROP POLICY IF EXISTS "Unified view access for bookings" ON public.bookings;
DROP POLICY IF EXISTS "Strict hybrid access for bookings" ON public.bookings;
CREATE POLICY "Strict hybrid access for bookings" ON public.bookings 
FOR SELECT 
USING (
    (user_id IN (SELECT user_id FROM public.users WHERE auth_id = auth.uid())) 
    OR 
    EXISTS (
        SELECT 1 FROM public.trips t 
        WHERE t.trip_id = public.bookings.trip_id 
        AND public.can_access_private_data(t.partner_id)
    )
    OR
    (public.is_admin())
);

COMMIT;


