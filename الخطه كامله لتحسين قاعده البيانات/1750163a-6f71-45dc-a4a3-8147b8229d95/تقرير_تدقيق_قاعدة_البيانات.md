# ุชูุฑูุฑ ุชุฏููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
## ูุธุงู ุญุฌุฒ ุงูุญุงููุงุช - ุชุญููู ุดุงูู

**ุชุงุฑูุฎ ุงูุชุฏููู:** 2026-01-26  
**ูุธุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช:** PostgreSQL (Supabase)  
**ุฏูุฑ ุงููุฏูู:** ูููุฏุณ ูุนูุงุฑู ุฃูู ูููุงุนุฏ ุงูุจูุงูุงุช ูุฃุฎุตุงุฆู ุณูุงูุฉ ุงูุจูุงูุงุช

---

## ุงูููุฎุต ุงูุชูููุฐู

ููููู ูุฐุง ุงูุชุฏููู ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููุตุฉ ุญุฌุฒ ุญุงููุงุช ูุชุนุฏุฏุฉ ุงููุณุชุฃุฌุฑูู. ููุธูุฑ ุงููููู **ูุถุฌูุง ูุชูุณุทูุง** ูุน ุนุฏุฉ ููุงุท ููุฉ ูู ุงูุฃูุงู (ุณูุงุณุงุช RLS) ูููุทู ุงูุฃุนูุงู (ุณูุงุณุงุช ุงูุฅูุบุงุกุ ุชุชุจุน ุงูุนูููุงุช). ููุน ุฐููุ ุชูุฌุฏ **ูุดุงูู ูููููุฉ ุญุฑุฌุฉ** ุชูุนุฑูุถ ุณูุงูุฉ ุงูุจูุงูุงุช ููุฎุทุฑุ ูุชุฎูู ูุฎุงุทุฑ ุฃุฏุงุกุ ูุชูุชูู ูุจุงุฏุฆ ุงูุชุทุจูุน.

**ุงูุชูููู ุงูุนุงู:** โ๏ธ **ูุชุทูุจ ุงูุชูุงููุง ููุฑููุง**

---

## 1. ุงูุฑุจุท ุจูู ุงูุฌุฏุงูู ูุณูุงูุฉ ุงูุนูููุงุช

### 1.1 ูููุฏ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ุงูููููุฏุฉ

> [!CAUTION]
> **ูุดููุฉ ุญุฑุฌุฉ:** ุงููููู ูุง ูุญุฏุฏ ุฃู ูููุฏ ููุงุชูุญ ุฃุฌูุจูุฉ ุตุฑูุญุฉ ุฑุบู ูุฌูุฏ ุงูุนุฏูุฏ ูู ุงูุชุจุนูุงุช ุงูุนูุงุฆููุฉ. ูุฐุง ุงูุชูุงู ุฎุทูุฑ ูุฃูุถู ููุงุฑุณุงุช ููุงุนุฏ ุงูุจูุงูุงุช ุงูุนูุงุฆููุฉ.

#### ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ุงูููููุฏุฉ ุงููุญุฏุฏุฉ:

| ุงูุฌุฏูู ุงููุฑุนู | ุงูุนููุฏ | ูุฌุจ ุฃู ูุดูุฑ ุฅูู | ุงูุชุฃุซูุฑ |
|---------------|---------|------------------|----------|
| `user_roles` | `user_id` | `auth.users(id)` | ุฅููุงููุฉ ูุฌูุฏ ุณุฌูุงุช ุฃุฏูุงุฑ ูุชููุฉ |
| `user_roles` | `partner_id` | `partners(partner_id)` | ูุฑุงุฌุน ุดุฑูุงุก ุบูุฑ ุตุงูุญุฉ |
| `partner_applications` | `auth_user_id` | `auth.users(id)` | ุทูุจุงุช ูุชููุฉ |
| `partner_applications` | `partner_id` | `partners(partner_id)` | ุฑูุงุจุท ุดุฑูุงุก ุบูุฑ ุตุงูุญุฉ |
| `branches` | `partner_id` | `partners(partner_id)` | ูุฑูุน ูุชููุฉ |
| `users` | `auth_id` | `auth.users(id)` | ุนุฏู ุชุทุงุจู ุงูููู ุงูุดุฎุตู/ุงููุตุงุฏูุฉ |
| `employees` | `user_id` | `users(user_id)` | ูุฑุงุฌุน ูุณุชุฎุฏููู ุบูุฑ ุตุงูุญุฉ |
| `employees` | `partner_id` | `partners(partner_id)` | ูุฑุงุฌุน ุดุฑูุงุก ุบูุฑ ุตุงูุญุฉ |
| `drivers` | `partner_id` | `partners(partner_id)` | ุณุงุฆููู ูุชุงูู |
| `buses` | `partner_id` | `partners(partner_id)` | ุญุงููุงุช ูุชููุฉ |
| `buses` | `bus_class_id` | `bus_classes(bus_class_id)` | ูุฑุงุฌุน ูุฆุงุช ุบูุฑ ุตุงูุญุฉ |
| `seats` | `bus_id` | `buses(bus_id)` | ููุงุนุฏ ูุชููุฉ |
| `routes` | `partner_id` | `partners(partner_id)` | ููููุฉ ูุณุงุฑุงุช ุบูุฑ ุตุงูุญุฉ |
| `route_stops` | `route_id` | `routes(route_id)` | ูุญุทุงุช ูุชููุฉ |
| `trips` | `route_id` | `routes(route_id)` | ูุฑุงุฌุน ูุณุงุฑุงุช ุบูุฑ ุตุงูุญุฉ |
| `trips` | `bus_id` | `buses(bus_id)` | ุชุนูููุงุช ุญุงููุงุช ุบูุฑ ุตุงูุญุฉ |
| `trips` | `driver_id` | `drivers(driver_id)` | ุชุนูููุงุช ุณุงุฆููู ุบูุฑ ุตุงูุญุฉ |
| `bookings` | `user_id` | `users(user_id)` | ุญุฌูุฒุงุช ูุณุชุฎุฏููู ุบูุฑ ุตุงูุญุฉ |
| `bookings` | `trip_id` | `trips(trip_id)` | ุญุฌูุฒุงุช ุฑุญูุงุช ุบูุฑ ุตุงูุญุฉ |
| `passengers` | `booking_id` | `bookings(booking_id)` | ุฑูุงุจ ูุชุงูู |
| `passengers` | `seat_id` | `seats(seat_id)` | ุชุนูููุงุช ููุงุนุฏ ุบูุฑ ุตุงูุญุฉ |
| `commissions` | `booking_id` | `bookings(booking_id)` | ุนูููุงุช ูุชููุฉ |
| `payment_transactions` | `booking_id` | `bookings(booking_id)` | ูุฏููุนุงุช ูุชููุฉ |
| `refunds` | `booking_id` | `bookings(booking_id)` | ุงุณุชุฑุฏุงุฏุงุช ูุชููุฉ |
| `notifications` | `user_id` | `users(user_id)` | ุฅุดุนุงุฑุงุช ูุชููุฉ |
| `ratings` | `user_id` | `users(user_id)` | ูุฑุงุฌุน ูุณุชุฎุฏููู ุบูุฑ ุตุงูุญุฉ |
| `ratings` | `trip_id` | `trips(trip_id)` | ูุฑุงุฌุน ุฑุญูุงุช ุบูุฑ ุตุงูุญุฉ |

**ุงูุนูุงูุจ:**
- **ุงูุจูุงูุงุช ุงููุชููุฉ:** ูููู ุฃู ุชูุฌุฏ ุณุฌูุงุช ูุฑุนูุฉ ุจุฏูู ุณุฌูุงุช ุฃุตููุฉ ุตุงูุญุฉ
- **ุงูุชูุงูุงุช ุงูุณูุงูุฉ ุงููุฑุฌุนูุฉ:** ูุง ููุฌุฏ ูุฑุถ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุนูุงูุงุช
- **ูุดุงูู ุงูุชุณูุณู:** ุฅุฏุงุฑุฉ ุงูุญุฐู ูุฏูููุง ูุทููุจุฉุ ุนุฑุถุฉ ููุฃุฎุทุงุก
- **ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช:** ูุง ูููู ุงูุงุณุชูุงุฏุฉ ูู ููุงุฑุณ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ููุฑุจุท
- **ุฎุทุฑ ูุณุงุฏ ุงูุจูุงูุงุช:** ุฃุฎุทุงุก ูุณุชูู ุงูุชุทุจูู ูููู ุฃู ุชุฎูู ุจูุงูุงุช ุบูุฑ ูุชุณูุฉ

#### ุงูุชูุตูุงุช:

```sql
-- ุฃูุซูุฉ ุนูู ุฅุถุงูุฉ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ (ุทุจู ุงูููุท ุนูู ุฌููุน ุงูุฌุฏุงูู):

-- user_roles
ALTER TABLE public.user_roles 
  ADD CONSTRAINT fk_user_roles_user 
  FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;

ALTER TABLE public.user_roles 
  ADD CONSTRAINT fk_user_roles_partner 
  FOREIGN KEY (partner_id) REFERENCES public.partners(partner_id) ON DELETE SET NULL;

-- bookings (ุฌุฏูู ุญุฑุฌ)
ALTER TABLE public.bookings 
  ADD CONSTRAINT fk_bookings_user 
  FOREIGN KEY (user_id) REFERENCES public.users(user_id) ON DELETE RESTRICT;

ALTER TABLE public.bookings 
  ADD CONSTRAINT fk_bookings_trip 
  FOREIGN KEY (trip_id) REFERENCES public.trips(trip_id) ON DELETE RESTRICT;

-- passengers
ALTER TABLE public.passengers 
  ADD CONSTRAINT fk_passengers_booking 
  FOREIGN KEY (booking_id) REFERENCES public.bookings(booking_id) ON DELETE CASCADE;

ALTER TABLE public.passengers 
  ADD CONSTRAINT fk_passengers_seat 
  FOREIGN KEY (seat_id) REFERENCES public.seats(seat_id) ON DELETE RESTRICT;

-- ุทุจู ููุทูุง ููุงุซูุงู ุนูู ุฌููุน ุงูุฌุฏุงูู ุฐุงุช ุงูุนูุงูุงุช ุงูุฃุฌูุจูุฉ
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ููุฐ ููุฑูุง**

---

### 1.2 ูุธุงู ูููุฉ ุงููุณุชุฎุฏู ุงููุฒุฏูุฌ

> [!IMPORTANT]
> ุงููุธุงู ูุญุชูุธ ุจุฌุฏูููู ูููุตููู ููููุฉ ุงููุณุชุฎุฏู (`auth.users` ู `public.users`)ุ ููุง ูุฎูู ูุฎุงุทุฑ ูุฒุงููุฉ.

**ุงููููู ุงูุญุงูู:**
```
auth.users (ูุตุงุฏูุฉ Supabase)
    โ (ูุฑุฌุน auth_id)
public.users (ูููุงุช ุงูุชุทุจูู ุงูุดุฎุตูุฉ)
    โ (ูุฑุฌุน user_id)
bookings, notifications, ุฅูุฎ.
```

**ุงููุดุงูู:**
1. **ุฎุทุฑ ุงููุฒุงููุฉ:** `public.users` ูููู ุฃู ูููุฏ ุงููุฒุงููุฉ ูุน `auth.users`
2. **ุจูุงูุงุช ููุฑุฑุฉ:** ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงูุงุณู ูุฎุฒูุงู ูู ููุง ุงูููุงููู
3. **ุงุณุชุนูุงูุงุช ูุนูุฏุฉ:** ุชุชุทูุจ ุฑุจุทูุง ุนุจุฑ ููุง ุงูุฌุฏูููู ูุนูููุงุช ุงููุณุชุฎุฏู
4. **ุงุนุชูุงุฏ ุนูู ุงููุญูุฒ:** ูุนุชูุฏ ุนูู ูุญูุฒ `handle_new_user()` ุงูุฐู ูุงุฌู ูุดุงูู (ุญุณุจ ุณุฌู ุงูุชุฑุญูู)

**ุงูุฏููู ูู ูููุงุช ุงูุชุฑุญูู:**
- `20251224223000_root_cause_fix.sql` ููุธูุฑ ููุทู ุชูุธูู ุงูุชูุฑุงุฑุงุช
- ุฅุตูุงุญุงุช ูุชุนุฏุฏุฉ ููุดุงูู ูุฒุงููุฉ ุงููุณุชุฎุฏู/ุงูุฏูุฑ

#### ุงูุชูุตูุงุช:

**ุงูุฎูุงุฑ ุฃ: ุฅูุบุงุก public.users (ููุถู)**
```sql
-- ุชุฑุญูู ุฌููุน ููุงุชูุญ user_id ุงูุฃุฌูุจูุฉ ููุฅุดุงุฑุฉ ุฅูู auth.users(id) ูุจุงุดุฑุฉ
-- ุชุฎุฒูู ุจูุงูุงุช ุงูููู ุงูุดุฎุตู ุงูุฅุถุงููุฉ ูู ุฌุฏูู ูููุตู ุฅุฐุง ูุฒู ุงูุฃูุฑ
CREATE TABLE public.user_profiles (
  auth_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  phone VARCHAR,
  preferences JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**ุงูุฎูุงุฑ ุจ: ุงูุงุญุชูุงุธ ุจุงููููู ุงูุญุงูู ููู ุชุนุฒูุฒู**
```sql
-- ุฅุถุงูุฉ ููุฏ ููุชุงุญ ุฃุฌูุจู
ALTER TABLE public.users 
  ADD CONSTRAINT fk_users_auth 
  FOREIGN KEY (auth_id) REFERENCES auth.users(id) ON DELETE CASCADE;

-- ุฅุถุงูุฉ ููุฏ ูุฑูุฏ (ููุฌูุฏ ุจุงููุนู ุญุณุจ ุงูุชุฑุญูู)
ALTER TABLE public.users 
  ADD CONSTRAINT users_auth_id_key UNIQUE (auth_id);
```

**ุงูุฃููููุฉ:** ๐ **ุนุงููุฉ - ุฎุทุท ููุฅุตุฏุงุฑ ุงูุฑุฆูุณู ุงูุชุงูู**

---

## 2. ููุน ุชูุฑุงุฑ ุงูุจูุงูุงุช ูุงูุชุทุจูุน

### 2.1 ุชูููู ูุณุชูู ุงูุชุทุจูุน

**ุงูุชูููู ุงูุนุงู:** ุงููููู ูู ุญูุงูู **2NF (ุงูุดูู ุงูุทุจูุนู ุงูุซุงูู)** ูุน ุจุนุถ ุงูุงูุชูุงูุงุช.

#### ุงูุงูุชูุงูุงุช ุงููุญุฏุฏุฉ:

**2.1.1 ุจูุงูุงุช ูุงููุฉ ุบูุฑ ูุทุจุนุฉ ูู ุฌุฏูู `bookings`**

> [!WARNING]
> ุฌุฏูู `bookings` ูุฎุฒู ููููุง ูุญุณูุจุฉ ูุฌุจ ุงุดุชูุงููุง ุฃู ุชุฎุฒูููุง ูู ุฌุฏุงูู ูุฎุตุตุฉ.

```sql
CREATE TABLE public.bookings (
  -- ... ุญููู ุฃุฎุฑู ...
  total_price numeric NOT NULL,           -- โ ููุจูู (ููุทุฉ ุงููุนุงููุฉ)
  platform_commission numeric,            -- โ๏ธ ูุฌุจ ุญุณุงุจูุง
  partner_revenue numeric,                -- โ๏ธ ูุฌุจ ุญุณุงุจูุง
  refund_amount numeric,                  -- โ๏ธ ุชูุฑุฑ booking_cancellations
  refund_timestamp timestamp,             -- โ๏ธ ุชูุฑุฑ booking_cancellations
  -- ...
);
```

**ุงููุดุงูู:**
- `platform_commission` ู `partner_revenue` ูุงุจูุฉ ููุงุดุชูุงู ูู `total_price` ููุณุจุฉ ุงูุนูููุฉ
- `refund_amount` ู `refund_timestamp` ุชูุฑุฑ ุงูุจูุงูุงุช ูู `booking_cancellations` ู `refund_transactions`

**ุงูุชูุตูุฉ:**

**ุฅุฐุง ูุงูุช ูุฐู ููุทุงุช ููุตูุฏุฉ** (ููุณุงุฑ ุชุฏููู ูุงูู):
```sql
-- ุฅุถุงูุฉ ุชุนูููุงุช ูุชูุถูุญ ุงูููุฉ
COMMENT ON COLUMN bookings.platform_commission IS 
  'ููุทุฉ ูู ุงูุนูููุฉ ููุช ุงูุญุฌุฒ - ูุง ุชุนูุฏ ุงูุญุณุงุจ';
COMMENT ON COLUMN bookings.partner_revenue IS 
  'ููุทุฉ ูู ุฅูุฑุงุฏุงุช ุงูุดุฑูู ููุช ุงูุญุฌุฒ - ูุง ุชุนูุฏ ุงูุญุณุงุจ';
```

**ุฅุฐุง ูุงู ูุฌุจ ุญุณุงุจูุง:**
```sql
-- ุฅุฒุงูุฉ ุงูุฃุนูุฏุฉ ุงูุฒุงุฆุฏุฉ
ALTER TABLE bookings DROP COLUMN platform_commission;
ALTER TABLE bookings DROP COLUMN partner_revenue;
ALTER TABLE bookings DROP COLUMN refund_amount;
ALTER TABLE bookings DROP COLUMN refund_timestamp;

-- ุฅูุดุงุก ุนุฑุถ ููููู ุงููุญุณูุจุฉ
CREATE VIEW bookings_with_financials AS
SELECT 
  b.*,
  b.total_price * (p.commission_percentage / 100) AS platform_commission,
  b.total_price * (1 - p.commission_percentage / 100) AS partner_revenue,
  bc.refund_amount,
  bc.cancelled_at AS refund_timestamp
FROM bookings b
JOIN trips t ON b.trip_id = t.trip_id
JOIN partners p ON t.partner_id = p.partner_id
LEFT JOIN booking_cancellations bc ON b.booking_id = bc.booking_id;
```

**ุงูุฃููููุฉ:** ๐ก **ูุชูุณุทุฉ - ูุถุญ ุงูููุฉุ ุซู ููุฐ**

---

**2.1.2 ูุฑุฌุน ุฑุญูุฉ ุฒุงุฆุฏ ูู ุฌุฏูู `passengers`**

```sql
CREATE TABLE public.passengers (
  passenger_id bigint PRIMARY KEY,
  booking_id bigint,      -- ูุดูุฑ ุฅูู bookings
  trip_id bigint,         -- โ๏ธ ุฒุงุฆุฏ - ูุงุจู ููุงุดุชูุงู ูู ุงูุญุฌุฒ
  seat_id bigint,
  -- ...
);
```

**ุงููุดููุฉ:** `trip_id` ุฒุงุฆุฏ ูุฃู:
```sql
-- ูููู ุงุดุชูุงู trip_id:
SELECT t.trip_id 
FROM passengers p
JOIN bookings b ON p.booking_id = b.booking_id
JOIN trips t ON b.trip_id = t.trip_id;
```

**ุงูุชูุตูุฉ:**
```sql
-- ุฅุฒุงูุฉ ุงูุนููุฏ ุงูุฒุงุฆุฏ
ALTER TABLE passengers DROP COLUMN trip_id;

-- ุฅุฐุง ูุงูุช ุงูุงุณุชุนูุงูุงุช ุชุญุชุงุฌ trip_id ุจุดูู ูุชูุฑุฑุ ุฃูุดุฆ ุนุฑุถูุง ูููุฑุณูุง
CREATE MATERIALIZED VIEW passengers_with_trip AS
SELECT p.*, b.trip_id
FROM passengers p
JOIN bookings b ON p.booking_id = b.booking_id;

CREATE INDEX idx_passengers_trip ON passengers_with_trip(trip_id);
```

**ุงูุฃููููุฉ:** ๐ข **ููุฎูุถุฉ - ุญุณูู ุฃุซูุงุก ุฅุนุงุฏุฉ ุงูููููุฉ**

---

**2.1.3 ุฌุฏุงูู ุงุณุชุฑุฏุงุฏ ููุฑุฑุฉ**

> [!CAUTION]
> ููุฌุฏ ุฌุฏููุงู ูููุตูุงู ููุงุณุชุฑุฏุงุฏ ุจุฃุบุฑุงุถ ูุชุฏุงุฎูุฉุ ููุง ูุฎูู ุงุฑุชุจุงููุง ูุนุฏู ุงุชุณุงู ูุญุชูู ููุจูุงูุงุช.

**ุงูุฌุฏุงูู:**
1. `refunds` (ุงูุฃุณุทุฑ 426-439)
2. `refund_transactions` (ุงูุฃุณุทุฑ 442-466)

**ุงูุชุฏุงุฎู:**
- ููุงููุง ูุชุชุจุน `booking_id`ุ `refund_amount`ุ `status`ุ `created_at`
- ููุงููุง ูุชุชุจุน ุชูุงุตูู ุทุฑููุฉ ุงูุฏูุน (ุญุณุงุจ ุจูููุ STC Pay)
- ุบูุฑ ูุงุถุญ ุฃูููุง ููุซูู

**ุงูุชูุตูุฉ:**

**ุงูุฎูุงุฑ ุฃ: ุฏูุฌ ูู ุฌุฏูู ูุงุญุฏ**
```sql
CREATE TABLE public.refund_transactions (
  refund_id BIGSERIAL PRIMARY KEY,
  booking_id BIGINT NOT NULL REFERENCES bookings(booking_id),
  user_id BIGINT NOT NULL REFERENCES users(user_id),
  
  -- ุงูุชูุงุตูู ุงููุงููุฉ
  refund_amount NUMERIC NOT NULL,
  refund_fee NUMERIC DEFAULT 0,
  net_refund NUMERIC GENERATED ALWAYS AS (refund_amount - refund_fee) STORED,
  
  -- ุชูุงุตูู ุงูุฏูุน
  refund_method VARCHAR NOT NULL,
  original_payment_method VARCHAR,
  refund_reference VARCHAR,
  
  -- ุชูุงุตูู ุงูุชุญููู ุงูุจููู
  bank_name VARCHAR,
  bank_account VARCHAR,
  account_holder_name VARCHAR,
  
  -- ุชูุงุตูู STC Pay
  stc_pay_number VARCHAR,
  
  -- ุชุชุจุน ุณูุฑ ุงูุนูู
  status VARCHAR DEFAULT 'pending',
  initiated_by BIGINT REFERENCES users(user_id),
  processed_by BIGINT REFERENCES users(user_id),
  completed_by BIGINT REFERENCES users(user_id),
  
  -- ููุงุญุธุงุช
  customer_notes TEXT,
  internal_notes TEXT,
  
  -- ุงูุทูุงุจุน ุงูุฒูููุฉ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  processing_started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  CONSTRAINT valid_refund_amount CHECK (refund_amount > 0)
);
```

**ุงูุฃููููุฉ:** ๐ **ุนุงููุฉ - ูุถุญ ููุฑูุง ูููุน ุนุฏู ุงุชุณุงู ุงูุจูุงูุงุช**

---

### 2.2 ุงููููุฏ ุงููุฑูุฏุฉ ูููุน ุงูุชูุฑุงุฑ

#### 2.2.1 ุงููููุฏ ุงููุฑูุฏุฉ ุงูููููุฏุฉ

> [!WARNING]
> ุนุฏุฉ ุฌุฏุงูู ุชูุชูุฑ ุฅูู ูููุฏ ูุฑูุฏุฉ ูู ุดุฃููุง ููุน ุงูุชูุฑุงุฑุงุช ุงูููุทููุฉ.

| ุงูุฌุฏูู | ุงูููุฏ ุงูููููุฏ | ุงูุฎุทุฑ |
|--------|---------------|-------|
| `buses` | `license_plate` | ุชุณุฌููุงุช ูุฑูุจุงุช ููุฑุฑุฉ |
| `drivers` | `license_number` | ุฑุฎุต ุณุงุฆููู ููุฑุฑุฉ |
| `users` | `email` | ุนูุงููู ุจุฑูุฏ ุฅููุชุฑููู ููุฑุฑุฉ |
| `users` | `phone` | ุฃุฑูุงู ููุงุชู ููุฑุฑุฉ |
| `seats` | `(bus_id, seat_number)` | ุฃุฑูุงู ููุงุนุฏ ููุฑุฑุฉ ููู ุญุงููุฉ |
| `routes` | `(origin_city, destination_city, partner_id)` | ูุณุงุฑุงุช ููุฑุฑุฉ |
| `route_stops` | `(route_id, stop_order)` | ุชุฑุชูุจุงุช ูุญุทุงุช ููุฑุฑุฉ |
| `partner_invoices` | `invoice_number` | ุฃุฑูุงู ููุงุชูุฑ ููุฑุฑุฉ |

**ุงูุชูุตูุงุช:**

```sql
-- ุงูุญุงููุงุช: ููุน ููุญุงุช ุชุฑุฎูุต ููุฑุฑุฉ
ALTER TABLE buses 
  ADD CONSTRAINT uk_buses_license_plate UNIQUE (license_plate);

-- ุงูุณุงุฆููู: ููุน ุฑุฎุต ููุฑุฑุฉ
ALTER TABLE drivers 
  ADD CONSTRAINT uk_drivers_license_number UNIQUE (license_number);

-- ุงูููุงุนุฏ: ููุน ุฃุฑูุงู ููุงุนุฏ ููุฑุฑุฉ ููู ุญุงููุฉ
ALTER TABLE seats 
  ADD CONSTRAINT uk_seats_bus_seat UNIQUE (bus_id, seat_number);

-- ุงููุณุงุฑุงุช: ููุน ูุณุงุฑุงุช ููุฑุฑุฉ ููู ุดุฑูู
ALTER TABLE routes 
  ADD CONSTRAINT uk_routes_partner_cities 
  UNIQUE (partner_id, origin_city, destination_city);

-- ูุญุทุงุช ุงููุณุงุฑ: ููุน ุชุฑุชูุจุงุช ูุญุทุงุช ููุฑุฑุฉ
ALTER TABLE route_stops 
  ADD CONSTRAINT uk_route_stops_order UNIQUE (route_id, stop_order);

-- ุงูููุงุชูุฑ: ุฃุฑูุงู ููุงุชูุฑ ูุฑูุฏุฉ
ALTER TABLE partner_invoices 
  ADD CONSTRAINT uk_partner_invoices_number UNIQUE (invoice_number);
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ููุฐ ูุจู ุงูุฅูุชุงุฌ**

---

#### 2.2.2 ูุดุงูู ูููุฏ ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู

**ุฏููู ูู ุณุฌู ุงูุชุฑุญูู:**

ุชุฑุญูู `20251224223000_root_cause_fix.sql` ููุดู ุนูุจูุง ุชุตูููููุง ุญุฑุฌูุง:

```sql
-- ุงูุฃุณุทุฑ 42-43: ุชุบููุฑ ูู UUID PK ุฅูู user_id PK
ALTER TABLE public.user_roles ADD CONSTRAINT user_roles_pkey PRIMARY KEY (user_id);
```

**ุงููุดููุฉ:** ูุฐุง ููุฑุถ **ุฏูุฑูุง ูุงุญุฏูุง ููู ูุณุชุฎุฏู**ุ ููู ุงูุชุตููู ุงูุฃุตูู ุงุณุชุฎุฏู UUID PKุ ููุง ูุดูุฑ ุฅูู ุฃู **ุฃุฏูุงุฑูุง ูุชุนุฏุฏุฉ ููู ูุณุชุฎุฏู** ูุงูุช ููุตูุฏุฉ.

**ุงูุญุงูุฉ ุงูุญุงููุฉ:** ุฏูุฑ ูุงุญุฏ ููู ูุณุชุฎุฏู (ููุฑูุถ ุจูุงุณุทุฉ PK)  
**ุงููุชุทูุจ ุงููุญุชูู:** ุฃุฏูุงุฑ ูุชุนุฏุฏุฉ ููู ูุณุชุฎุฏู (ูุซูุงูุ ุงููุณุชุฎุฏู ุดุฑูู ูุณุงุฆู)

**ุงูุชูุตูุฉ:**

**ุฅุฐุง ูุงูุช ุงูุฃุฏูุงุฑ ุงููุชุนุฏุฏุฉ ูุทููุจุฉ:**
```sql
-- ุงูุนูุฏุฉ ุฅูู ููุฏ ูุฑูุฏ ูุฑูุจ
ALTER TABLE user_roles DROP CONSTRAINT user_roles_pkey;
ALTER TABLE user_roles ADD PRIMARY KEY (id);
ALTER TABLE user_roles ADD CONSTRAINT uk_user_roles_user_role 
  UNIQUE (user_id, role);
```

**ุฅุฐุง ูุงู ุงูุฏูุฑ ุงููุงุญุฏ ุตุญูุญูุง:**
```sql
-- ุงูุชุตููู ุงูุญุงูู ุตุญูุญุ ููู ุฃุถู ุชูุซูููุง
COMMENT ON TABLE user_roles IS 
  'ูุฎุฒู ุงูุฏูุฑ ุงูุฃุณุงุณู ููู ูุณุชุฎุฏู. ูู ูุณุชุฎุฏู ูุฏูู ุฏูุฑ ูุงุญุฏ ุจุงูุถุจุท.';
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ูุถุญ ูุชุทูุจ ุงูุนูู ููุฑูุง**

---

## 3. ุชุญููู ุงูุนูุงูุงุช ุจูู ุงูุฌุฏุงูู

### 3.1 ุฎุฑูุทุฉ ุงูุนูุงูุงุช

#### ุนูุงูุงุช ุงูููุงูุงุช ุงูุฃุณุงุณูุฉ:

```mermaid
erDiagram
    PARTNERS ||--o{ BRANCHES : ูููู
    PARTNERS ||--o{ DRIVERS : ููุธู
    PARTNERS ||--o{ BUSES : ูููู
    PARTNERS ||--o{ ROUTES : ูุดุบู
    PARTNERS ||--o{ TRIPS : ูุฌุฏูู
    
    USERS ||--o{ USER_ROLES : ูุฏูู
    USERS ||--o{ BOOKINGS : ูููู_ุจู
    USERS ||--o{ RATINGS : ููุฏู
    
    ROUTES ||--o{ ROUTE_STOPS : ูุญุชูู
    ROUTES ||--o{ TRIPS : ูุณุชุฎุฏู
    
    BUSES ||--o{ SEATS : ูุญุชูู
    BUSES ||--o{ TRIPS : ูุฎุตุต_ูู
    
    DRIVERS ||--o{ TRIPS : ูููุฏ
    
    TRIPS ||--o{ BOOKINGS : ูุณุชูุจู
    TRIPS ||--o{ PASSENGERS : ูุญูู
    
    BOOKINGS ||--o{ PASSENGERS : ูุดูู
    BOOKINGS ||--o{ PAYMENT_TRANSACTIONS : ูุฏูู
    BOOKINGS ||--o{ COMMISSIONS : ูููุฏ
```

---

### 3.2 ูุดุงูู ุงูุนูุงูุงุช

#### 3.2.1 ููููุฉ ุบุงูุถุฉ: ุฌุฏูู ุงูุญุงููุงุช

```sql
CREATE TABLE public.buses (
  bus_id bigint PRIMARY KEY,
  partner_id bigint,        -- ููููุฉ ุงูุดุฑูู
  owner_user_id bigint,     -- โ๏ธ ููููุฉ ูุฑุฏูุฉุ
  -- ...
);
```

> [!WARNING]
> ุฌุฏูู `buses` ูุฏูู ูู ูู `partner_id` ู `owner_user_id`ุ ููุง ูุฎูู ุฏูุงูุงุช ููููุฉ ุบุงูุถุฉ.

**ุฃุณุฆูุฉ:**
- ูู ูููู ุฃู ุชููู ุงูุญุงููุฉ ูููููุฉ ููุณุชุฎุฏู ููุณ ุฌุฒุกูุง ูู ุงูุดุฑููุ
- ูู `owner_user_id` ูููุตุฏ ุจู ุชุชุจุน ุงููุฑุฏ ุฏุงุฎู ุงูุดุฑูู ุงูุฐู ุณุฌู ุงูุญุงููุฉุ
- ูุงุฐุง ูุญุฏุซ ุฅุฐุง ุบุงุฏุฑ `owner_user_id` ุงูุดุฑููุ

**ุงูุชูุตูุฉ:**

**ุงูุฎูุงุฑ ุฃ: ุฅุฒุงูุฉ ุงูููููุฉ ุงููุฑุฏูุฉ**
```sql
ALTER TABLE buses DROP COLUMN owner_user_id;
-- ุชุชุจุน ูุณุชุฎุฏู ุงูุชุณุฌูู ูู ุฌุฏูู ุงูุชุฏููู ุจุฏูุงู ูู ุฐูู
```

**ุงูุฎูุงุฑ ุจ: ุชูุถูุญ ูู "registered_by"**
```sql
ALTER TABLE buses RENAME COLUMN owner_user_id TO registered_by_user_id;
COMMENT ON COLUMN buses.registered_by_user_id IS 
  'ุงููุณุชุฎุฏู ุงูุฐู ุณุฌู ูุฐู ุงูุญุงููุฉ (ููุณุงุฑ ุงูุชุฏููู ููุท)';
```

**ุงูุฃููููุฉ:** ๐ก **ูุชูุณุทุฉ - ูุถุญ ููุทู ุงูุนูู**

---

#### 3.2.2 ุนูุจ ุชุตููู ุญุฑุฌ: ุชููุฑ ุงูููุงุนุฏ

**ุงูุชุตููู ุงูุญุงูู:**
```sql
CREATE TABLE seats (
  seat_id bigint PRIMARY KEY,
  bus_id bigint,
  seat_number varchar,
  is_available boolean DEFAULT true  -- โ๏ธ ุนูุงูุฉ ุนุงูุฉุ ูููุณุช ุฎุงุตุฉ ุจุงูุฑุญูุฉ
);
```

> [!CAUTION]
> **ุนูุจ ุชุตููู ุญุฑุฌ:** `is_available` ูู ุนูุงูุฉ ุนุงูุฉุ ููู ุชููุฑ ุงูููุนุฏ **ุฎุงุต ุจุงูุฑุญูุฉ**.

**ุงููุดููุฉ:** ูููู ุฃู ูููู ุงูููุนุฏ ูุชุงุญูุง ููุฑุญูุฉ ุฃ ููู ูุญุฌูุฒูุง ููุฑุญูุฉ ุจ. ุงูุชุตููู ุงูุญุงูู ูุง ููููู ุชูุซูู ูุฐุง.

**ุงูุชูุตูุฉ:**

**ุงูุฎูุงุฑ ุฃ: ุฅุฒุงูุฉ is_availableุ ุงุดุชููุง ูู passengers**
```sql
ALTER TABLE seats DROP COLUMN is_available;

-- ุงุณุชุนูุงู ุงูููุงุนุฏ ุงููุชุงุญุฉ ูุฑุญูุฉ
CREATE VIEW trip_seat_availability AS
SELECT 
  t.trip_id,
  s.seat_id,
  s.seat_number,
  s.bus_id,
  CASE 
    WHEN p.passenger_id IS NULL THEN TRUE 
    ELSE FALSE 
  END AS is_available
FROM trips t
JOIN buses b ON t.bus_id = b.bus_id
JOIN seats s ON b.bus_id = s.bus_id
LEFT JOIN passengers p ON s.seat_id = p.seat_id 
  AND p.trip_id = t.trip_id
  AND p.passenger_status = 'active';

-- ููุฑุณ ููุฃุฏุงุก
CREATE INDEX idx_passengers_seat_trip 
  ON passengers(seat_id, trip_id) 
  WHERE passenger_status = 'active';
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ุฃุตูุญ ููุฑูุง (ุนูุจ ูููุฐุฌ ุงูุจูุงูุงุช)**

---

## 4. ุงูุชูุงูู ุงููุธููู ูุขุซุงุฑ ุงูุฃุฏุงุก

### 4.1 ุงุณุชุฑุงุชูุฌูุฉ ุงูููุฑุณุฉ

> [!CAUTION]
> **ูุดููุฉ ุฃุฏุงุก ุญุฑุฌุฉ:** ุงููููู ูุง ูุญุฏุฏ ููุงุฑุณ ุตุฑูุญุฉ ุจุฎูุงู ุงูููุงุชูุญ ุงูุฃุณุงุณูุฉ.

#### ุงูููุงุฑุณ ุงูุญุฑุฌุฉ ุงูููููุฏุฉ:

**ููุงุฑุณ ุนุงููุฉ ุงูุฃููููุฉ (ุงุณุชุนูุงูุงุช ูุชูุฑุฑุฉ):**

```sql
-- ุงูุญุฌูุฒุงุช: ุจุญุซ ุงููุณุชุฎุฏู
CREATE INDEX idx_bookings_user_id ON bookings(user_id);
CREATE INDEX idx_bookings_trip_id ON bookings(trip_id);
CREATE INDEX idx_bookings_status ON bookings(booking_status) 
  WHERE booking_status != 'completed';

-- ุงูุฑุญูุงุช: ุงุณุชุนูุงูุงุช ูุทุงู ุงูุชุงุฑูุฎ
CREATE INDEX idx_trips_departure_time ON trips(departure_time);
CREATE INDEX idx_trips_partner_id ON trips(partner_id);
CREATE INDEX idx_trips_status ON trips(status) 
  WHERE status IN ('scheduled', 'boarding');

-- ุงูุฑูุงุจ: ุจุญุซ ุงูุญุฌุฒ
CREATE INDEX idx_passengers_booking_id ON passengers(booking_id);

-- ุงูุฅุดุนุงุฑุงุช: ุฑุณุงุฆู ุงููุณุชุฎุฏู ุบูุฑ ุงูููุฑูุกุฉ
CREATE INDEX idx_notifications_user_unread 
  ON notifications(user_id, is_read) 
  WHERE is_read = FALSE;

-- ุงูุชููููุงุช: ุชุฌููุนุงุช ุงูุดุฑูู/ุงูุณุงุฆู
CREATE INDEX idx_ratings_partner_id ON ratings(partner_id);
CREATE INDEX idx_ratings_driver_id ON ratings(driver_id);

-- ุงููุณุงุฑุงุช: ุนูููุงุช ุจุญุซ ุงููุฏู
CREATE INDEX idx_routes_origin ON routes(origin_city);
CREATE INDEX idx_routes_destination ON routes(destination_city);
CREATE INDEX idx_routes_cities ON routes(origin_city, destination_city);

-- ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู: ุจุญุซ ุงููุตุงุฏูุฉ
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);

-- ุงููุณุชุฎุฏููู: ุจุญุซ ุงููุตุงุฏูุฉ
CREATE INDEX idx_users_auth_id ON users(auth_id);

-- ูุนุงููุงุช ุงูุฏูุน: ุจุญุซ ุงูุญุฌุฒ
CREATE INDEX idx_payment_transactions_booking_id 
  ON payment_transactions(booking_id);

-- ุงูุนูููุงุช: ุชูุงุฑูุฑ ุงูุดุฑูู ุงููุงููุฉ
CREATE INDEX idx_commissions_partner_id ON commissions(partner_id);
CREATE INDEX idx_commissions_booking_id ON commissions(booking_id);
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ููุฐ ููุฑูุง ููุฅูุชุงุฌ**

---

### 4.2 ูุดุงูู ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช

#### 4.2.1 ุฃุฏุงุก ุณูุงุณุงุช RLS

**ุณูุงุณุงุช RLS ุงูุญุงููุฉ:**

```sql
-- ูุซุงู: ุณูุงุณุฉ ุงูุญุฌูุฒุงุช
CREATE POLICY "Users can view their own bookings" ON public.bookings
  FOR SELECT USING (user_id IN (SELECT user_id FROM users WHERE auth_id = auth.uid()));
```

> [!WARNING]
> **ูุดููุฉ ุฃุฏุงุก:** ุงูุงุณุชุนูุงู ุงููุฑุนู ูู ุณูุงุณุฉ RLS ููููุฐ ููู ูุญุต ุตู.

**ุงูุชูุตูุฉ:**

```sql
-- ุชุญุณูู ุจุฑุจุท ูุจุงุดุฑ
CREATE POLICY "Users can view their own bookings" ON public.bookings
  FOR SELECT USING (
    user_id = (SELECT user_id FROM users WHERE auth_id = auth.uid() LIMIT 1)
  );

-- ุฃูุถู: ุงุณุชุฎุฏู ุฏุงูุฉ ูุน ุงูุชุฎุฒูู ุงููุคูุช
CREATE OR REPLACE FUNCTION get_current_user_id()
RETURNS BIGINT
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT user_id FROM users WHERE auth_id = auth.uid() LIMIT 1;
$$;

-- ุซู ุงุณุชุฎุฏู ูู ุงูุณูุงุณุฉ
CREATE POLICY "Users can view their own bookings" ON public.bookings
  FOR SELECT USING (user_id = get_current_user_id());
```

**ุงูุฃููููุฉ:** ๐ **ุนุงููุฉ - ุญุณูู ูุจู ุงูุชูุณุน**

---

### 4.3 ูุฎุงูู ูุงุจููุฉ ุงูุชูุณุน

#### 4.3.1 ููู ุงูุฌุฏูู ุบูุฑ ุงููุญุฏูุฏ

**ุงูุฌุฏุงูู ุงููุนุฑุถุฉ ููุฎุทุฑ:**

| ุงูุฌุฏูู | ูุนุฏู ุงูููู | ุงูุฎุทุฑ | ุงูุชุฎููู |
|--------|-----------|-------|---------|
| `bookings` | ุนุงูู (ููู ูุนุงููุฉ) | ุชุจุงุทุค ุงูุงุณุชุนูุงู | ุงูุชูุณูู ุญุณุจ ุงูุชุงุฑูุฎ |
| `passengers` | ุนุงูู (ููู ููุนุฏ ูุจุงุน) | ูุณุญ ุฌุฏุงูู ูุจูุฑุฉ | ุงูุชูุณูู ุญุณุจ ุงูุชุงุฑูุฎ |
| `notifications` | ุนุงูู ุฌุฏูุง (ููู ุญุฏุซ) | ุงูุชูุงุฎ ุงูุชุฎุฒูู | ุงุณุชุฑุงุชูุฌูุฉ ุงูุฃุฑุดูุฉ |
| `messages` | ุนุงูู (ูุธุงู ุงูุฏุฑุฏุดุฉ) | ุงูุชูุงุฎ ุงูุชุฎุฒูู | ุงูุชูุณูู + ุงูุฃุฑุดูุฉ |
| `payment_transactions` | ุนุงูู (ููู ุฏูุนุฉ) | ุงุณุชุนูุงูุงุช ุชุฏููู ุจุทูุฆุฉ | ุงูุชูุณูู ุญุณุจ ุงูุชุงุฑูุฎ |

**ุงูุชูุตูุฉ:**

```sql
-- ุชูุณูู ุงูุญุฌูุฒุงุช ุญุณุจ ุงูุดูุฑ
CREATE TABLE bookings_partitioned (
  LIKE bookings INCLUDING ALL
) PARTITION BY RANGE (booking_date);

-- ุฅูุดุงุก ุงูุฃูุณุงู
CREATE TABLE bookings_2026_01 PARTITION OF bookings_partitioned
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

**ุงูุฃููููุฉ:** ๐ก **ูุชูุณุทุฉ - ููุฐ ูุจู 100 ุฃูู ุญุฌุฒ**

---

## 5. ุงูุฃูุงู ูุณูุงูุฉ ุงูุจูุงูุงุช

### 5.1 ุชุญููู ุฃูุงู ูุณุชูู ุงูุตู (RLS)

**ููุงุท ุงูููุฉ:**
โ RLS ููุนูู ุนูู ุฌููุน ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ  
โ ุนุฒู ุจูุงูุงุช ุงูุดุฑูู ูุทุจู  
โ ุงููุตูู ุฅูู ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏู ููุฑูุถ  

**ููุงุท ุงูุถุนู:**

#### 5.1.1 RLS ููููุฏ ุนูู ุฌุฏุงูู ุญุฑุฌุฉ

**ุฌุฏุงูู ุจุฏูู RLS (ูู ุงููููู):**

| ุงูุฌุฏูู | ุงูุฎุทุฑ | ุงูุชูุตูุฉ |
|--------|------|----------|
| `buses` | โ ูุง RLS | ุชูุนูู ุนุฒู ุงูุดุฑูู |
| `users` | โ ูุง RLS | ุชูุนูู ูุตูู ุงููุณุชุฎุฏู ุงูุฐุงุชู ููุท |
| `payment_transactions` | โ ูุง RLS | ุชูุนูู ูุตูู ุงููุณุชุฎุฏู/ุงููุณุคูู ููุท |
| `refunds` | โ ูุง RLS | ุชูุนูู ูุตูู ุงููุณุชุฎุฏู/ุงููุณุคูู ููุท |
| `conversations` | โ ูุง RLS | ุชูุนูู ูุตูู ุงููุณุชุฎุฏู ุงูุฐุงุชู ููุท |
| `messages` | โ ูุง RLS | ุชูุนูู ูุตูู ุงููุดุงุฑููู ูู ุงููุญุงุฏุซุฉ |

**ุงูุชูุตูุฉ:**

```sql
-- ุชูุนูู RLS ุนูู ุงูุฌุฏุงูู ุงูููููุฏุฉ
ALTER TABLE buses ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE refunds ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- ุฅุถุงูุฉ ุงูุณูุงุณุงุช
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth_id = auth.uid());

CREATE POLICY "Users can view own payments" ON payment_transactions
  FOR SELECT USING (user_id = get_current_user_id());
```

**ุงูุฃููููุฉ:** ๐ด **ุญุฑุฌ - ุซุบุฑุฉ ุฃูููุฉ**

---

### 5.2 ูููุฏ ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช

#### 5.2.1 ูููุฏ CHECK ุงูููููุฏุฉ

> [!WARNING]
> ุงููููู ููุชูุฑ ุฅูู ูููุฏ CHECK ููุฑุถ ููุงุนุฏ ุงูุนูู.

**ุงูุชุญููุงุช ุงูููููุฏุฉ:**

```sql
-- ุงูุญุฌูุฒุงุช: ุถูุงู ุฃุณุนุงุฑ ููุฌุจุฉ
ALTER TABLE bookings 
  ADD CONSTRAINT chk_bookings_total_price 
  CHECK (total_price > 0);

-- ุงูุฑุญูุงุช: ุถูุงู ุฃููุงุช ููุทููุฉ
ALTER TABLE trips 
  ADD CONSTRAINT chk_trips_times 
  CHECK (arrival_time > departure_time);

-- ุงูุญุงููุงุช: ุถูุงู ุณุนุฉ ููุฌุจุฉ
ALTER TABLE buses 
  ADD CONSTRAINT chk_buses_capacity 
  CHECK (capacity > 0 AND capacity <= 100);

-- ุงูุชููููุงุช: ุถูุงู ูุทุงู ูุฌูู ุตุงูุญ
ALTER TABLE ratings 
  ADD CONSTRAINT chk_ratings_stars 
  CHECK (stars >= 1 AND stars <= 5);

-- ุณูุงุณุงุช ุงูุฅูุบุงุก: ุถูุงู ูุณุจ ุตุงูุญุฉ
ALTER TABLE cancel_policies 
  ADD CONSTRAINT chk_cancel_policies_refund 
  CHECK (refund_percentage >= 0 AND refund_percentage <= 100);

-- ุงูุดุฑูุงุก: ุถูุงู ุนูููุฉ ุตุงูุญุฉ
ALTER TABLE partners 
  ADD CONSTRAINT chk_partners_commission 
  CHECK (commission_percentage >= 0 AND commission_percentage <= 100);

-- ุงูุงุณุชุฑุฏุงุฏุงุช: ุถูุงู ูุจุงูุบ ููุฌุจุฉ
ALTER TABLE refunds 
  ADD CONSTRAINT chk_refunds_amount 
  CHECK (refund_amount > 0);
```

**ุงูุฃููููุฉ:** ๐ **ุนุงููุฉ - ููุน ุฅุฏุฎุงู ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ**

---

## 6. ููุฎุต ุงููุดุงูู ุงูุญุฑุฌุฉ

### ๐ด ุญุฑุฌ (ุฃุตูุญ ููุฑูุง)

1. **ูุง ุชูุฌุฏ ูููุฏ ููุงุชูุญ ุฃุฌูุจูุฉ** - ุงููููู ุจุงููุงูู ููุชูุฑ ุฅูู ุงูุณูุงูุฉ ุงููุฑุฌุนูุฉ
2. **ุนูุจ ุชุตููู ุชููุฑ ุงูููุงุนุฏ** - ูุง ูููู ุชุชุจุน ุงูุชููุฑ ุงูุฎุงุต ุจุงูุฑุญูุฉ
3. **ูููุฏ ูุฑูุฏุฉ ููููุฏุฉ** - ูุณูุญ ุจุฑุฎุต ููุฑุฑุฉุ ููุงุนุฏุ ููุงุชูุฑ
4. **ุชุนุงุฑุถ ููุฏ ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู** - ุฏูุฑ ูุงุญุฏ ููุงุจู ุฃุฏูุงุฑ ูุชุนุฏุฏุฉ ุบูุฑ ูุงุถุญ
5. **ููุงุฑุณ ููููุฏุฉ** - ุณูุณุจุจ ุชุฏููุฑูุง ุดุฏูุฏูุง ูู ุงูุฃุฏุงุก
6. **RLS ููููุฏ ุนูู ุงูุฌุฏุงูู ุงููุงููุฉ** - ุซุบุฑุฉ ุฃูููุฉ

### ๐ ุฃููููุฉ ุนุงููุฉ (ุนุงูุฌ ูุฑูุจูุง)

7. **ุฌุฏุงูู ุงุณุชุฑุฏุงุฏ ููุฑุฑุฉ** - ุฎุทุฑ ุนุฏู ุงุชุณุงู ุงูุจูุงูุงุช
8. **ุฃุฏุงุก ุณูุงุณุงุช RLS** - ุงุณุชุนูุงูุงุช ูุฑุนูุฉ ูู ุงูุณูุงุณุงุช
9. **ูุณุงุฑุงุช ุชุฏููู ููููุฏุฉ** - ุฎุทุฑ ุงูุงูุชุซุงู
10. **ูููุฏ CHECK ููููุฏุฉ** - ูููู ุฅุฏุฎุงู ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ
11. **ูุฒุงููุฉ ุงูููุธู-ุงูุฏูุฑ** - ูุง ุชูุฌุฏ ุขููุฉ ูุฑุถ

### ๐ก ุฃููููุฉ ูุชูุณุทุฉ (ุฎุทุท ูุฅุนุงุฏุฉ ุงูููููุฉ)

12. **ูุธุงู ูููุฉ ุงููุณุชุฎุฏู ุงููุฒุฏูุฌ** - ุชุนููุฏ ุงููุฒุงููุฉ
13. **ุจูุงูุงุช ูุงููุฉ ุบูุฑ ูุทุจุนุฉ** - ูุถุญ ุงูููุฉ (ููุทุฉ ููุงุจู ูุญุณูุจุฉ)
14. **ููููุฉ ุญุงููุฉ ุบุงูุถุฉ** - ููุทู ุงูุนูู ุบูุฑ ูุงุถุญ
15. **ุชุฎุทูุท ูุงุจููุฉ ุงูุชูุณุน** - ุงุณุชุฑุงุชูุฌูุฉ ุงูุชูุณูู ูุทููุจุฉ

### ๐ข ุฃููููุฉ ููุฎูุถุฉ (ุญุณูู ูุงุญููุง)

16. **ุฃุนูุฏุฉ ุฒุงุฆุฏุฉ** - `passengers.trip_id`ุ `commissions.trip_id`
17. **ุงุณุชุฑุงุชูุฌูุฉ PK ุบูุฑ ูุชุณูุฉ** - ุฃููุงุน UUID/BIGINT ูุฎุชูุทุฉ

---

## 7. ุฎุงุฑุทุฉ ุทุฑูู ุงูุชูููุฐ ุงูููุตู ุจูุง

### ุงููุฑุญูุฉ 1: ุฃุณุงุณ ุณูุงูุฉ ุงูุจูุงูุงุช (ุงูุฃุณุจูุน 1-2)
1. ุฅุถุงูุฉ ุฌููุน ูููุฏ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ
2. ุฅุถุงูุฉ ุงููููุฏ ุงููุฑูุฏุฉ (ุงูุฑุฎุตุ ุงูููุงุนุฏุ ุงูููุงุชูุฑ)
3. ุฅุตูุงุญ ููุฏ user_roles (ุชูุถูุญ ุฏูุฑ ูุงุญุฏ ููุงุจู ุฃุฏูุงุฑ ูุชุนุฏุฏุฉ)
4. ุฅุถุงูุฉ ูููุฏ CHECK ูููุงุนุฏ ุงูุนูู

### ุงููุฑุญูุฉ 2: ุชุญุณูู ุงูุฃุฏุงุก (ุงูุฃุณุจูุน 3-4)
5. ุฅูุดุงุก ุฌููุน ุงูููุงุฑุณ ุงูุญุฑุฌุฉ
6. ุชุญุณูู ุณูุงุณุงุช RLS
7. ุฅุตูุงุญ ุชุตููู ุชููุฑ ุงูููุงุนุฏ
8. ุชูููุฐ ูุฑุงูุจุฉ ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช

### ุงููุฑุญูุฉ 3: ุชุนุฒูุฒ ุงูุฃูุงู (ุงูุฃุณุจูุน 5)
9. ุชูุนูู RLS ุนูู ุฌููุน ุงูุฌุฏุงูู
10. ุฅุถุงูุฉ ุณูุงุณุงุช RLS ุงูููููุฏุฉ
11. ุชูููุฐ ุชุณุฌูู ุชุฏููู ุดุงูู
12. ุงุฎุชุจุงุฑ ุงุฎุชุฑุงู ุฃููู

### ุงููุฑุญูุฉ 4: ุงูุชุญุถูุฑ ููุงุจููุฉ ุงูุชูุณุน (ุงูุฃุณุจูุน 6-8)
13. ุชูููุฐ ุชูุณูู ุงูุฌุฏุงูู
14. ุฅุนุฏุงุฏ ุงุณุชุฑุงุชูุฌูุงุช ุงูุฃุฑุดูุฉ
15. ุชุญุณูู ูุธุงู ุงูุฅุดุนุงุฑุงุช
16. ุงุฎุชุจุงุฑ ุงูุญูู ูุงูุถุจุท

### ุงููุฑุญูุฉ 5: ุงูุชุญุณูู (ุงูุฃุณุจูุน 9-10)
17. ุญู ูุธุงู ูููุฉ ุงููุณุชุฎุฏู ุงููุฒุฏูุฌ
18. ุชูุถูุญ ููุฉ ุงูุจูุงูุงุช ุบูุฑ ุงููุทุจุนุฉ
19. ุฅุฒุงูุฉ ุงูุฃุนูุฏุฉ ุงูุฒุงุฆุฏุฉ
20. ุงูุชูุซูู ูููู ุงููุนุฑูุฉ

---

## 8. ุงูุฎูุงุตุฉ

ููุธูุฑ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช **ููุฐุฌุฉ ุฌูุฏุฉ ูููุทู ุงูุฃุนูุงู** ูุน ุชุบุทูุฉ ุดุงููุฉ ูุณูุฑ ุนูู ุงูุญุฌุฒุ ูุณูุงุณุงุช ุงูุฅูุบุงุกุ ูุงูุชุชุจุน ุงููุงูู. ููุน ุฐููุ **ุฃูุฌู ุงููุตูุฑ ุงููููููุฉ ุงูุญุฑุฌุฉ** ูู ุงูุณูุงูุฉ ุงููุฑุฌุนูุฉุ ูุงูููุฑุณุฉุ ูุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุชุฎูู ูุฎุงุทุฑ ูุจูุฑุฉ ููุณุงุฏ ุงูุจูุงูุงุชุ ูุชุฏููุฑ ุงูุฃุฏุงุกุ ูุงูุซุบุฑุงุช ุงูุฃูููุฉ.

**ูุทููุจ ุฅุฌุฑุงุก ููุฑู** ุนูู ุงูุนูุงุตุฑ ุงูุญุฑุฌุฉ ูุนุงููุฉ ุงูุฃููููุฉ ูุจู ุฃู ูููู ุงุนุชุจุงุฑ ูุฐุง ุงููุธุงู ุฌุงูุฒูุง ููุฅูุชุงุฌ ุนูู ูุทุงู ูุงุณุน.

### ููุงุท ุงูููุฉ ุงูุฑุฆูุณูุฉ:
โ ุฃููุงุน enum ุดุงููุฉ ูุงุชุณุงู ุงูุจูุงูุงุช  
โ ุชุทุจูู ุฃูุงู ูุณุชูู ุงูุตู (ุฌุฒุฆู)  
โ ูุณุงุฑ ุชุฏููู ูุชุบููุฑุงุช ุงูุฃุฏูุงุฑ  
โ ูุธุงู ุณูุงุณุฉ ุฅูุบุงุก ูุชุทูุฑ  
โ ูุนูุงุฑูุฉ ูุชุนุฏุฏุฉ ุงููุณุชุฃุฌุฑูู ูุน ุนุฒู ุงูุดุฑูู  

### ููุงุท ุงูุถุนู ุงูุฑุฆูุณูุฉ:
โ ูุง ุชูุฌุฏ ูููุฏ ููุงุชูุญ ุฃุฌูุจูุฉ (ูุงุฑุซู ูุณูุงูุฉ ุงูุจูุงูุงุช)  
โ ูุง ุชูุฌุฏ ููุงุฑุณ ุจุฎูุงู ุงูููุงุชูุญ ุงูุฃุณุงุณูุฉ (ูุงุฑุซุฉ ุฃุฏุงุก ุนูู ูุทุงู ูุงุณุน)  
โ ูููุฐุฌ ุชููุฑ ููุงุนุฏ ูุนูุจ (ููุทู ุงูุนูู ูุนุทู)  
โ ุชุบุทูุฉ RLS ุบูุฑ ููุชููุฉ (ูุฌูุงุช ุฃูููุฉ)  
โ ูููุฏ ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ููููุฏุฉ (ูุณูุญ ุจุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ)  

**ุงูุชูุตูุฉ:** ููุฐ ุนูุงุตุฑ ุงููุฑุญูุฉ 1 ูุงููุฑุญูุฉ 2 ููุฑูุง ูุจู ุงููุดุฑ ูู ุงูุฅูุชุงุฌ. ูุฌุจ ุฃู ุชุชุจุน ุงููุฑุงุญู 3-5 ูู ุบุถูู 2-3 ุฃุดูุฑ ูู ุงูุฅุทูุงู.

---

**ููุงูุฉ ุชูุฑูุฑ ุงูุชุฏููู**
