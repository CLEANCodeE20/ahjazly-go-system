# Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª
## Ø®Ø§Ø±Ø·Ø© Ø·Ø±ÙŠÙ‚ Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:** 2026-01-26  
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 1.0  
**Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:** 16 Ø£Ø³Ø¨ÙˆØ¹ (4 Ø£Ø´Ù‡Ø±)  
**Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©:** Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©

---

## ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©](#Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©)
2. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 0: Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-0-Ø§Ù„ØªØ­Ø¶ÙŠØ±-ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯)
3. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø£Ø³Ø§Ø³ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-1-Ø£Ø³Ø§Ø³-Ø³Ù„Ø§Ù…Ø©-Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
4. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-2-ØªØ­Ø³ÙŠÙ†-Ø§Ù„Ø£Ø¯Ø§Ø¡)
5. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-3-ØªØ¹Ø²ÙŠØ²-Ø§Ù„Ø£Ù…Ø§Ù†)
6. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-4-Ø§Ù„Ù…ÙŠØ²Ø§Øª-Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©)
7. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙˆØ³Ø¹](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-5-Ø§Ù„ØªØ­Ø¶ÙŠØ±-Ù„Ù‚Ø§Ø¨Ù„ÙŠØ©-Ø§Ù„ØªÙˆØ³Ø¹)
8. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ù„ØªØ­Ø³ÙŠÙ† ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚](#Ø§Ù„Ù…Ø±Ø­Ù„Ø©-6-Ø§Ù„ØªØ­Ø³ÙŠÙ†-ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚)
9. [Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­](#Ù…Ø¹Ø§ÙŠÙŠØ±-Ø§Ù„Ù†Ø¬Ø§Ø­)
10. [Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±](#Ø¥Ø¯Ø§Ø±Ø©-Ø§Ù„Ù…Ø®Ø§Ø·Ø±)

---

## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

### Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
ØªØ­ÙˆÙŠÙ„ Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª Ø¥Ù„Ù‰ Ù…Ù†ØµØ© **Ù…ØªÙƒØ§Ù…Ù„Ø©ØŒ Ø¢Ù…Ù†Ø©ØŒ ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ø¹** ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ†:
- âœ… Ø£Ù…Ø§Ù† PostgreSQL Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (RLS)
- âœ… Ù…ÙŠØ²Ø§Øª MySQL Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© (ØªØ®Ø·ÙŠØ· Ø§Ù„Ø­Ø§ÙÙ„Ø§ØªØŒ RBACØŒ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠØ©)
- âœ… Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª ÙÙŠ ØªØµÙ…ÙŠÙ… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- âœ… Ø£Ø¯Ø§Ø¡ Ø¹Ø§Ù„ÙŠ ÙˆÙ‚Ø§Ø¨Ù„ÙŠØ© ØªÙˆØ³Ø¹

### Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„ØªØ£Ø«ÙŠØ± | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© |
|---------|---------|----------|
| Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Foreign Keys | ÙØ³Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | ğŸ”´ Ø­Ø±Ø¬ |
| Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Indexes | Ø£Ø¯Ø§Ø¡ Ø³ÙŠØ¡ | ğŸ”´ Ø­Ø±Ø¬ |
| Ø¹ÙŠØ¨ ØªØµÙ…ÙŠÙ… ØªÙˆÙØ± Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ | Ù…Ù†Ø·Ù‚ Ø¹Ù…Ù„ Ù…Ø¹Ø·Ù„ | ğŸ”´ Ø­Ø±Ø¬ |
| Ù†Ø¸Ø§Ù… RBAC Ù…Ø­Ø¯ÙˆØ¯ | Ø£Ù…Ø§Ù† Ø¶Ø¹ÙŠÙ | ğŸŸ  Ø¹Ø§Ù„ÙŠ |
| Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø¸Ø§Ù… ØªØ®Ø·ÙŠØ· | ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ¦Ø© | ğŸŸ  Ø¹Ø§Ù„ÙŠ |

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 0: Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
**Ø§Ù„Ù…Ø¯Ø©:** Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯  
**Ø§Ù„Ù‡Ø¯Ù:** ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚

### 0.1 Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©

#### âœ… Ø§Ù„Ù…Ù‡Ø§Ù…:
```bash
# 1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
pg_dump -h [host] -U [user] -d [database] > backup_pre_migration_$(date +%Y%m%d).sql

# 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© ØªØ·ÙˆÙŠØ± Ù…Ù†ÙØµÙ„Ø©
# - Ø§Ø³ØªÙ†Ø³Ø§Ø® Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©
# - Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© staging

# 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
# - ØªÙØ¹ÙŠÙ„ pg_stat_statements
# - Ø¥Ø¹Ø¯Ø§Ø¯ monitoring dashboard
```

#### ğŸ“¦ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
- PostgreSQL 14+ (Ø£Ùˆ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
- pgAdmin Ø£Ùˆ DBeaver Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
- Git Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
- Ø£Ø¯Ø§Ø© migration (Ù…Ø«Ù„ Flyway Ø£Ùˆ Liquibase)

### 0.2 ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©

```sql
-- ÙØ­Øµ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
  n_live_tup AS row_count
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠØªÙŠÙ…Ø© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
SELECT 
  COUNT(*) as orphaned_passengers
FROM passengers p
LEFT JOIN bookings b ON p.booking_id = b.booking_id
WHERE b.booking_id IS NULL;
```

### 0.3 Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ (Rollback Plan)

```markdown
## Ø®Ø·Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©:

1. **Ù‚Ø¨Ù„ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©:**
   - Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
   - ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
   - Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø·Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹

2. **Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„:**
   - Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
   - Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
   - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨
   - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø£Ø³Ø§Ø³ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
**Ø§Ù„Ù…Ø¯Ø©:** Ø£Ø³Ø¨ÙˆØ¹Ø§Ù† (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2-3)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø­Ø±Ø¬Ø©

### 1.1 Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2: Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

```sql
-- Ù…Ù„Ù: migrations/001_add_core_foreign_keys.sql

-- 1. user_roles
ALTER TABLE user_roles 
  ADD CONSTRAINT fk_user_roles_user 
  FOREIGN KEY (user_id) REFERENCES auth.users(id) 
  ON DELETE CASCADE;

ALTER TABLE user_roles 
  ADD CONSTRAINT fk_user_roles_partner 
  FOREIGN KEY (partner_id) REFERENCES partners(partner_id) 
  ON DELETE SET NULL;

-- 2. partners
ALTER TABLE partners 
  ADD CONSTRAINT fk_partners_user 
  FOREIGN KEY (user_id) REFERENCES users(user_id) 
  ON DELETE RESTRICT;

-- 3. drivers
ALTER TABLE drivers 
  ADD CONSTRAINT fk_drivers_partner 
  FOREIGN KEY (partner_id) REFERENCES partners(partner_id) 
  ON DELETE CASCADE;

ALTER TABLE drivers 
  ADD CONSTRAINT fk_drivers_user 
  FOREIGN KEY (user_id) REFERENCES users(user_id) 
  ON DELETE CASCADE;

-- 4. buses
ALTER TABLE buses 
  ADD CONSTRAINT fk_buses_partner 
  FOREIGN KEY (partner_id) REFERENCES partners(partner_id) 
  ON DELETE CASCADE;

-- 5. routes
ALTER TABLE routes 
  ADD CONSTRAINT fk_routes_partner 
  FOREIGN KEY (partner_id) REFERENCES partners(partner_id) 
  ON DELETE CASCADE;

-- 6. trips
ALTER TABLE trips 
  ADD CONSTRAINT fk_trips_route 
  FOREIGN KEY (route_id) REFERENCES routes(route_id) 
  ON DELETE RESTRICT;

ALTER TABLE trips 
  ADD CONSTRAINT fk_trips_bus 
  FOREIGN KEY (bus_id) REFERENCES buses(bus_id) 
  ON DELETE SET NULL;

ALTER TABLE trips 
  ADD CONSTRAINT fk_trips_driver 
  FOREIGN KEY (driver_id) REFERENCES drivers(driver_id) 
  ON DELETE SET NULL;
```

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3: Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª

```sql
-- Ù…Ù„Ù: migrations/002_add_booking_financial_fks.sql

-- 1. bookings
ALTER TABLE bookings 
  ADD CONSTRAINT fk_bookings_user 
  FOREIGN KEY (user_id) REFERENCES users(user_id) 
  ON DELETE RESTRICT;

ALTER TABLE bookings 
  ADD CONSTRAINT fk_bookings_trip 
  FOREIGN KEY (trip_id) REFERENCES trips(trip_id) 
  ON DELETE RESTRICT;

-- 2. passengers
ALTER TABLE passengers 
  ADD CONSTRAINT fk_passengers_booking 
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id) 
  ON DELETE CASCADE;

ALTER TABLE passengers 
  ADD CONSTRAINT fk_passengers_seat 
  FOREIGN KEY (seat_id) REFERENCES seats(seat_id) 
  ON DELETE RESTRICT;

-- 3. payment_transactions
ALTER TABLE payment_transactions 
  ADD CONSTRAINT fk_payment_transactions_booking 
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id) 
  ON DELETE RESTRICT;

ALTER TABLE payment_transactions 
  ADD CONSTRAINT fk_payment_transactions_user 
  FOREIGN KEY (user_id) REFERENCES users(user_id) 
  ON DELETE RESTRICT;

-- 4. commissions
ALTER TABLE commissions 
  ADD CONSTRAINT fk_commissions_booking 
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id) 
  ON DELETE CASCADE;

ALTER TABLE commissions 
  ADD CONSTRAINT fk_commissions_partner 
  FOREIGN KEY (partner_id) REFERENCES partners(partner_id) 
  ON DELETE CASCADE;

-- 5. refunds
ALTER TABLE refunds 
  ADD CONSTRAINT fk_refunds_booking 
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id) 
  ON DELETE RESTRICT;

-- 6. notifications
ALTER TABLE notifications 
  ADD CONSTRAINT fk_notifications_user 
  FOREIGN KEY (user_id) REFERENCES users(user_id) 
  ON DELETE CASCADE;
```

### 1.2 Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯Ø©

```sql
-- Ù…Ù„Ù: migrations/003_add_unique_constraints.sql

-- 1. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø±Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
ALTER TABLE drivers 
  ADD CONSTRAINT uk_drivers_license_number 
  UNIQUE (license_number);

-- 2. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª
ALTER TABLE buses 
  ADD CONSTRAINT uk_buses_license_plate 
  UNIQUE (license_plate);

-- 3. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ù„ÙƒÙ„ Ø­Ø§ÙÙ„Ø©
ALTER TABLE seats 
  ADD CONSTRAINT uk_seats_bus_seat 
  UNIQUE (bus_id, seat_number);

-- 4. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„ÙƒÙ„ Ø´Ø±ÙŠÙƒ
ALTER TABLE routes 
  ADD CONSTRAINT uk_routes_partner_cities 
  UNIQUE (partner_id, origin_city, destination_city);

-- 5. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±
ALTER TABLE partner_invoices 
  ADD CONSTRAINT uk_partner_invoices_number 
  UNIQUE (invoice_number);

-- 6. Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± auth_id ÙÙŠ users
ALTER TABLE users 
  ADD CONSTRAINT uk_users_auth_id 
  UNIQUE (auth_id);
```

### 1.3 Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙˆØ¯ CHECK

```sql
-- Ù…Ù„Ù: migrations/004_add_check_constraints.sql

-- 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬Ø¨Ø©
ALTER TABLE bookings 
  ADD CONSTRAINT chk_bookings_total_price 
  CHECK (total_price > 0);

-- 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
ALTER TABLE trips 
  ADD CONSTRAINT chk_trips_times 
  CHECK (arrival_time > departure_time);

-- 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¹Ø© Ø§Ù„Ø­Ø§ÙÙ„Ø©
ALTER TABLE buses 
  ADD CONSTRAINT chk_buses_capacity 
  CHECK (capacity > 0 AND capacity <= 100);

-- 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
ALTER TABLE ratings 
  ADD CONSTRAINT chk_ratings_stars 
  CHECK (stars >= 1 AND stars <= 5);

-- 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
ALTER TABLE cancel_policies 
  ADD CONSTRAINT chk_cancel_policies_refund 
  CHECK (refund_percentage >= 0 AND refund_percentage <= 100);

-- 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
ALTER TABLE partners 
  ADD CONSTRAINT chk_partners_commission 
  CHECK (commission_percentage >= 0 AND commission_percentage <= 100);

-- 7. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
ALTER TABLE refunds 
  ADD CONSTRAINT chk_refunds_amount 
  CHECK (refund_amount > 0);
```

### 1.4 Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø©

```sql
-- Ù…Ù„Ù: tests/001_integrity_tests.sql

-- Ø§Ø®ØªØ¨Ø§Ø± 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙŠÙ…Ø©
DO $$
DECLARE
  orphan_count INTEGER;
BEGIN
  -- ÙØ­Øµ Ø§Ù„Ø±ÙƒØ§Ø¨ Ø§Ù„ÙŠØªØ§Ù…Ù‰
  SELECT COUNT(*) INTO orphan_count
  FROM passengers p
  LEFT JOIN bookings b ON p.booking_id = b.booking_id
  WHERE b.booking_id IS NULL;
  
  IF orphan_count > 0 THEN
    RAISE EXCEPTION 'Found % orphaned passengers', orphan_count;
  END IF;
  
  RAISE NOTICE 'All integrity tests passed!';
END $$;
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
**Ø§Ù„Ù…Ø¯Ø©:** Ø£Ø³Ø¨ÙˆØ¹Ø§Ù† (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4-5)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø­Ø±Ø¬Ø©

### 2.1 Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø­Ø±Ø¬Ø©

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4: ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

```sql
-- Ù…Ù„Ù: migrations/005_create_core_indexes.sql

-- 1. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…ØªÙƒØ±Ø±Ø© Ø¬Ø¯Ù‹Ø§)
CREATE INDEX idx_bookings_user_id 
  ON bookings(user_id) 
  WHERE booking_status != 'completed';

CREATE INDEX idx_bookings_trip_id 
  ON bookings(trip_id);

CREATE INDEX idx_bookings_status_date 
  ON bookings(booking_status, booking_date DESC);

CREATE INDEX idx_bookings_reference 
  ON bookings(booking_reference);

-- 2. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø±Ø­Ù„Ø§Øª (Ø¨Ø­Ø« ÙˆØªØµÙÙŠØ©)
CREATE INDEX idx_trips_departure_time 
  ON trips(departure_time) 
  WHERE status = 'scheduled';

CREATE INDEX idx_trips_partner_status 
  ON trips(partner_id, status);

CREATE INDEX idx_trips_route_date 
  ON trips(route_id, departure_time);

-- 3. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø±ÙƒØ§Ø¨
CREATE INDEX idx_passengers_booking_id 
  ON passengers(booking_id);

CREATE INDEX idx_passengers_trip_id 
  ON passengers(trip_id);

CREATE INDEX idx_passengers_status 
  ON passengers(passenger_status) 
  WHERE passenger_status = 'active';

-- 4. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
CREATE INDEX idx_users_auth_id 
  ON users(auth_id);

CREATE INDEX idx_user_roles_user_id 
  ON user_roles(user_id);

CREATE INDEX idx_user_roles_partner_id 
  ON user_roles(partner_id) 
  WHERE partner_id IS NOT NULL;
```

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 5: ÙÙ‡Ø§Ø±Ø³ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª

```sql
-- Ù…Ù„Ù: migrations/006_create_analytics_indexes.sql

-- 1. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
CREATE INDEX idx_payment_transactions_booking 
  ON payment_transactions(booking_id);

CREATE INDEX idx_payment_transactions_user_date 
  ON payment_transactions(user_id, created_at DESC);

CREATE INDEX idx_payment_transactions_status 
  ON payment_transactions(payment_status, created_at DESC);

-- 2. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ§Ø¡)
CREATE INDEX idx_commissions_partner_date 
  ON commissions(partner_id, created_at DESC);

CREATE INDEX idx_commissions_booking 
  ON commissions(booking_id);

CREATE INDEX idx_commissions_status 
  ON commissions(commission_status);

-- 3. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
CREATE INDEX idx_ratings_partner_id 
  ON ratings(partner_id, created_at DESC);

CREATE INDEX idx_ratings_driver_id 
  ON ratings(driver_id, created_at DESC);

CREATE INDEX idx_ratings_trip_id 
  ON ratings(trip_id);

-- 4. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
CREATE INDEX idx_notifications_user_unread 
  ON notifications(user_id, is_read, created_at DESC) 
  WHERE is_read = FALSE;

-- 5. ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
CREATE INDEX idx_routes_cities 
  ON routes(origin_city, destination_city);

CREATE INDEX idx_routes_partner_active 
  ON routes(partner_id) 
  WHERE is_active = TRUE;
```

### 2.2 ØªØ­Ø³ÙŠÙ† Ø³ÙŠØ§Ø³Ø§Øª RLS

```sql
-- Ù…Ù„Ù: migrations/007_optimize_rls_policies.sql

-- Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù…Ø®Ø¨Ø£Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ user_id Ø§Ù„Ø­Ø§Ù„ÙŠ
CREATE OR REPLACE FUNCTION get_current_user_id()
RETURNS BIGINT
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT user_id 
  FROM users 
  WHERE auth_id = auth.uid() 
  LIMIT 1;
$$;

-- ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ø³Ø§Øª RLS Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
DROP POLICY IF EXISTS "Users can view their own bookings" ON bookings;
CREATE POLICY "Users can view their own bookings" ON bookings
  FOR SELECT 
  USING (user_id = get_current_user_id());

DROP POLICY IF EXISTS "Users can view their own passengers" ON passengers;
CREATE POLICY "Users can view their own passengers" ON passengers
  FOR SELECT 
  USING (
    booking_id IN (
      SELECT booking_id 
      FROM bookings 
      WHERE user_id = get_current_user_id()
    )
  );
```

### 2.3 Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡

```sql
-- Ù…Ù„Ù: tests/002_performance_tests.sql

-- ØªÙØ¹ÙŠÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§
EXPLAIN ANALYZE
SELECT b.*, u.full_name, t.departure_time
FROM bookings b
JOIN users u ON b.user_id = u.user_id
JOIN trips t ON b.trip_id = t.trip_id
WHERE b.user_id = 123
ORDER BY b.booking_date DESC
LIMIT 20;

-- ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° < 10ms
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†
**Ø§Ù„Ù…Ø¯Ø©:** Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 6)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”´ Ø­Ø±Ø¬Ø©

### 3.1 Ø¥ÙƒÙ…Ø§Ù„ ØªØºØ·ÙŠØ© RLS

```sql
-- Ù…Ù„Ù: migrations/008_complete_rls_coverage.sql

-- 1. ØªÙØ¹ÙŠÙ„ RLS Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
ALTER TABLE buses ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE refunds ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- 2. Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ù„Ù„Ø­Ø§ÙÙ„Ø§Øª
CREATE POLICY "Partners can view their own buses" ON buses
  FOR SELECT 
  USING (
    partner_id IN (
      SELECT partner_id 
      FROM user_roles 
      WHERE user_id = get_current_user_id()
    )
  );

CREATE POLICY "Partners can manage their own buses" ON buses
  FOR ALL 
  USING (
    partner_id IN (
      SELECT partner_id 
      FROM user_roles 
      WHERE user_id = get_current_user_id() 
      AND role = 'partner'
    )
  );

-- 3. Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT 
  USING (auth_id = auth.uid());

CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE 
  USING (auth_id = auth.uid());

-- 4. Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
CREATE POLICY "Users can view own payments" ON payment_transactions
  FOR SELECT 
  USING (user_id = get_current_user_id());

CREATE POLICY "Admins can view all payments" ON payment_transactions
  FOR SELECT 
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = get_current_user_id() 
      AND role = 'admin'
    )
  );

-- 5. Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
CREATE POLICY "Users can view own conversations" ON conversations
  FOR SELECT 
  USING (
    user_id = get_current_user_id() 
    OR partner_id IN (
      SELECT partner_id 
      FROM user_roles 
      WHERE user_id = get_current_user_id()
    )
  );
```

### 3.2 ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù…Ø§Ù†

```sql
-- Ù…Ù„Ù: tests/003_security_audit.sql

-- ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø¯ÙˆÙ† RLS
SELECT 
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
  AND rowsecurity = FALSE;

-- ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ø¬Ø¯Ø§ÙˆÙ„ lookup ÙÙ‚Ø·
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
**Ø§Ù„Ù…Ø¯Ø©:** 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 7-10)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ  Ø¹Ø§Ù„ÙŠØ©

### 4.1 Ù†Ø¸Ø§Ù… ØªØ®Ø·ÙŠØ· Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 7-8)

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 7: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„

```sql
-- Ù…Ù„Ù: migrations/009_bus_layout_system.sql

-- 1. Ø¬Ø¯ÙˆÙ„ ÙØ¦Ø§Øª Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª
CREATE TABLE bus_classes (
  class_id SERIAL PRIMARY KEY,
  name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO bus_classes (name, description) VALUES
  ('VIP', 'Ù…Ù‚Ø§Ø¹Ø¯ ÙØ§Ø®Ø±Ø© Ù…Ø¹ Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ©'),
  ('Standard', 'Ù…Ù‚Ø§Ø¹Ø¯ Ù‚ÙŠØ§Ø³ÙŠØ© Ù…Ø±ÙŠØ­Ø©'),
  ('Economy', 'Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©');

-- 2. Ø¬Ø¯ÙˆÙ„ ØªØ®Ø·ÙŠØ·Ø§Øª Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª
CREATE TABLE bus_layouts (
  layout_id SERIAL PRIMARY KEY,
  partner_id BIGINT NOT NULL REFERENCES partners(partner_id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  total_seats INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT chk_bus_layouts_total_seats CHECK (total_seats > 0 AND total_seats <= 100)
);

CREATE INDEX idx_bus_layouts_partner ON bus_layouts(partner_id);

-- 3. Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„ØªØ®Ø·ÙŠØ·
CREATE TABLE bus_layout_seats (
  layout_seat_id SERIAL PRIMARY KEY,
  layout_id INTEGER NOT NULL REFERENCES bus_layouts(layout_id) ON DELETE CASCADE,
  class_id INTEGER NOT NULL REFERENCES bus_classes(class_id),
  seat_number VARCHAR(10) NOT NULL,
  row_num INTEGER,
  col_num INTEGER,
  deck INTEGER NOT NULL DEFAULT 1,
  is_window BOOLEAN DEFAULT FALSE,
  is_aisle BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT uk_bus_layout_seats_layout_seat UNIQUE (layout_id, seat_number),
  CONSTRAINT chk_bus_layout_seats_deck CHECK (deck >= 1 AND deck <= 3),
  CONSTRAINT chk_bus_layout_seats_position CHECK (row_num > 0 AND col_num > 0)
);

CREATE INDEX idx_bus_layout_seats_layout ON bus_layout_seats(layout_id);
CREATE INDEX idx_bus_layout_seats_class ON bus_layout_seats(class_id);

-- 4. ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ØªØ®Ø·ÙŠØ·
ALTER TABLE buses 
  ADD COLUMN layout_id INTEGER REFERENCES bus_layouts(layout_id);

CREATE INDEX idx_buses_layout ON buses(layout_id);

-- 5. Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ is_available Ù…Ù† seats (Ø¹ÙŠØ¨ Ø§Ù„ØªØµÙ…ÙŠÙ…)
ALTER TABLE seats DROP COLUMN IF EXISTS is_available;

-- 6. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ layout_seat_id Ø¥Ù„Ù‰ seats
ALTER TABLE seats 
  ADD COLUMN layout_seat_id INTEGER REFERENCES bus_layout_seats(layout_seat_id);

CREATE INDEX idx_seats_layout_seat ON seats(layout_seat_id);
```

#### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 8: Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©

```sql
-- Ù…Ù„Ù: migrations/010_bus_layout_functions.sql

-- Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø·ÙŠØ·
CREATE OR REPLACE FUNCTION create_trip_seats_from_layout(
  p_trip_id BIGINT,
  p_bus_id BIGINT
)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_layout_id INTEGER;
  v_seats_created INTEGER := 0;
BEGIN
  -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ layout_id Ù…Ù† Ø§Ù„Ø­Ø§ÙÙ„Ø©
  SELECT layout_id INTO v_layout_id
  FROM buses
  WHERE bus_id = p_bus_id;
  
  IF v_layout_id IS NULL THEN
    RAISE EXCEPTION 'Bus % does not have a layout assigned', p_bus_id;
  END IF;
  
  -- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ù† Ø§Ù„ØªØ®Ø·ÙŠØ·
  INSERT INTO seats (bus_id, seat_number, layout_seat_id)
  SELECT 
    p_bus_id,
    bls.seat_number,
    bls.layout_seat_id
  FROM bus_layout_seats bls
  WHERE bls.layout_id = v_layout_id;
  
  GET DIAGNOSTICS v_seats_created = ROW_COUNT;
  
  RETURN v_seats_created;
END;
$$;

-- Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø±Ø­Ù„Ø©
CREATE OR REPLACE FUNCTION get_available_seats_for_trip(p_trip_id BIGINT)
RETURNS TABLE (
  seat_id BIGINT,
  seat_number VARCHAR,
  class_name VARCHAR,
  row_num INTEGER,
  col_num INTEGER,
  deck INTEGER,
  is_window BOOLEAN,
  is_aisle BOOLEAN
)
LANGUAGE SQL
STABLE
AS $$
  SELECT 
    s.seat_id,
    s.seat_number,
    bc.name AS class_name,
    bls.row_num,
    bls.col_num,
    bls.deck,
    bls.is_window,
    bls.is_aisle
  FROM seats s
  JOIN bus_layout_seats bls ON s.layout_seat_id = bls.layout_seat_id
  JOIN bus_classes bc ON bls.class_id = bc.class_id
  JOIN trips t ON s.bus_id = t.bus_id
  LEFT JOIN passengers p ON s.seat_id = p.seat_id 
    AND p.trip_id = p_trip_id 
    AND p.passenger_status = 'active'
  WHERE t.trip_id = p_trip_id
    AND p.passenger_id IS NULL;
$$;
```

### 4.2 Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø±Ù† (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 9)

```sql
-- Ù…Ù„Ù: migrations/011_flexible_pricing_system.sql

-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
CREATE TABLE fares (
  fare_id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(trip_id) ON DELETE CASCADE,
  class_id INTEGER NOT NULL REFERENCES bus_classes(class_id),
  price NUMERIC NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT uk_fares_trip_class UNIQUE (trip_id, class_id),
  CONSTRAINT chk_fares_price CHECK (price > 0)
);

CREATE INDEX idx_fares_trip ON fares(trip_id);
CREATE INDEX idx_fares_class ON fares(class_id);

-- 2. Ø¥Ø¶Ø§ÙØ© price_at_booking Ø¥Ù„Ù‰ passengers
ALTER TABLE passengers 
  ADD COLUMN price_at_booking NUMERIC;

-- 3. Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø­Ø¬Ø²
CREATE OR REPLACE FUNCTION calculate_booking_price(
  p_trip_id BIGINT,
  p_seat_ids BIGINT[]
)
RETURNS NUMERIC
LANGUAGE plpgsql
AS $$
DECLARE
  v_total_price NUMERIC := 0;
  v_seat_id BIGINT;
  v_class_id INTEGER;
  v_fare_price NUMERIC;
BEGIN
  FOREACH v_seat_id IN ARRAY p_seat_ids
  LOOP
    -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙØ¦Ø© Ø§Ù„Ù…Ù‚Ø¹Ø¯
    SELECT bls.class_id INTO v_class_id
    FROM seats s
    JOIN bus_layout_seats bls ON s.layout_seat_id = bls.layout_seat_id
    WHERE s.seat_id = v_seat_id;
    
    -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±
    SELECT price INTO v_fare_price
    FROM fares
    WHERE trip_id = p_trip_id AND class_id = v_class_id;
    
    IF v_fare_price IS NULL THEN
      RAISE EXCEPTION 'No fare found for trip % and class %', p_trip_id, v_class_id;
    END IF;
    
    v_total_price := v_total_price + v_fare_price;
  END LOOP;
  
  RETURN v_total_price;
END;
$$;
```

### 4.3 Ù†Ø¸Ø§Ù… RBAC Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 10)

```sql
-- Ù…Ù„Ù: migrations/012_advanced_rbac_system.sql

-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
CREATE TABLE permissions (
  permission_id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  module VARCHAR(50) NOT NULL,
  description_ar TEXT,
  description_en TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
CREATE TABLE role_permissions (
  role_id BIGINT REFERENCES user_roles(id) ON DELETE CASCADE,
  permission_id INTEGER REFERENCES permissions(permission_id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (role_id, permission_id)
);

-- 3. Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
INSERT INTO permissions (name, module, description_ar, description_en) VALUES
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
  ('trip:create', 'trip', 'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø­Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', 'Create new trips'),
  ('trip:read_all', 'trip', 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª', 'View all trips'),
  ('trip:read_own', 'trip', 'Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', 'View own trips'),
  ('trip:update', 'trip', 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø§Øª', 'Update trips'),
  ('trip:cancel', 'trip', 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø§Øª', 'Cancel trips'),
  
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
  ('booking:create', 'booking', 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯', 'Create booking'),
  ('booking:read_own', 'booking', 'Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', 'View own bookings'),
  ('booking:read_all', 'booking', 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª', 'View all bookings'),
  ('booking:cancel', 'booking', 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª', 'Cancel bookings'),
  
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  ('user:read_all', 'user', 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'View all users'),
  ('user:update_role', 'user', 'ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'Update user roles'),
  
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  ('admin:full_access', 'admin', 'ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…', 'Full system access'),
  ('partners:review', 'partners', 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Ø¡', 'Review partner applications'),
  ('partners:manage', 'partners', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡', 'Manage partners'),
  
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
  ('bus:create', 'partner_fleet', 'Ø¥Ø¶Ø§ÙØ© Ø­Ø§ÙÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'Add new bus'),
  ('bus:read_own', 'partner_fleet', 'Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', 'View own buses'),
  ('bus:update_own', 'partner_fleet', 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', 'Update own buses'),
  ('driver:create', 'partner_team', 'Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯', 'Add new driver'),
  ('driver:read_own', 'partner_team', 'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†', 'View drivers'),
  
  -- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  ('analytics:view_own', 'partner_reports', 'Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø®Ø§ØµØ©', 'View own analytics'),
  ('settlements:read_own', 'partner_reports', 'Ø¹Ø±Ø¶ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 'View settlements');

-- 4. Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
CREATE OR REPLACE FUNCTION has_permission(
  p_user_id BIGINT,
  p_permission_name VARCHAR
)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN role_permissions rp ON ur.id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.permission_id
    WHERE ur.user_id = p_user_id
      AND p.name = p_permission_name
  );
$$;
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙˆØ³Ø¹
**Ø§Ù„Ù…Ø¯Ø©:** Ø£Ø³Ø¨ÙˆØ¹Ø§Ù† (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 11-12)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©

### 5.1 ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©

```sql
-- Ù…Ù„Ù: migrations/013_table_partitioning.sql

-- 1. ØªÙ‚Ø³ÙŠÙ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
CREATE TABLE bookings_partitioned (
  LIKE bookings INCLUDING ALL
) PARTITION BY RANGE (booking_date);

-- Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
CREATE TABLE bookings_2026_01 PARTITION OF bookings_partitioned
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

CREATE TABLE bookings_2026_02 PARTITION OF bookings_partitioned
  FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

-- ... Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©

-- 2. ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
-- (ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ ÙÙŠ ÙˆÙ‚Øª Ø§Ù„ØµÙŠØ§Ù†Ø©)

-- 3. ØªÙ‚Ø³ÙŠÙ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
CREATE TABLE notifications_partitioned (
  LIKE notifications INCLUDING ALL
) PARTITION BY RANGE (created_at);
```

### 5.2 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ©

```sql
-- Ù…Ù„Ù: migrations/014_archiving_strategy.sql

-- 1. Ø¬Ø¯ÙˆÙ„ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
CREATE TABLE bookings_archive (
  LIKE bookings INCLUDING ALL
);

-- 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
CREATE OR REPLACE FUNCTION archive_old_bookings()
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_archived_count INTEGER;
BEGIN
  -- Ù†Ù‚Ù„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø£Ù‚Ø¯Ù… Ù…Ù† Ø³Ù†Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
  WITH archived AS (
    DELETE FROM bookings
    WHERE booking_date < CURRENT_DATE - INTERVAL '1 year'
      AND booking_status IN ('completed', 'cancelled')
    RETURNING *
  )
  INSERT INTO bookings_archive
  SELECT * FROM archived;
  
  GET DIAGNOSTICS v_archived_count = ROW_COUNT;
  
  RETURN v_archived_count;
END;
$$;

-- 3. Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
-- (ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ø¹Ø¨Ø± pg_cron Ø£Ùˆ cron job Ø®Ø§Ø±Ø¬ÙŠ)
```

---

## Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ù„ØªØ­Ø³ÙŠÙ† ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚
**Ø§Ù„Ù…Ø¯Ø©:** 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 13-16)  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø©

### 6.1 Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 13-14)

```sql
-- Ù…Ù„Ù: migrations/015_additional_features.sql

-- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯Ù† ÙˆØ§Ù„Ø¯ÙˆÙ„
CREATE TABLE countries (
  country_id SMALLSERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  code VARCHAR(10) NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE cities (
  city_id SERIAL PRIMARY KEY,
  country_id SMALLINT REFERENCES countries(country_id),
  name VARCHAR(100) NOT NULL,
  name_ar VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
INSERT INTO countries (name, code) VALUES
  ('Saudi Arabia', 'SA'),
  ('Yemen', 'YE');

INSERT INTO cities (country_id, name, name_ar) VALUES
  (1, 'Riyadh', 'Ø§Ù„Ø±ÙŠØ§Ø¶'),
  (1, 'Jeddah', 'Ø¬Ø¯Ø©'),
  (1, 'Dammam', 'Ø§Ù„Ø¯Ù…Ø§Ù…'),
  (2, 'Sana''a', 'ØµÙ†Ø¹Ø§Ø¡'),
  (2, 'Aden', 'Ø¹Ø¯Ù†'),
  (2, 'Taiz', 'ØªØ¹Ø²');

-- 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙƒØ§Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙŠÙ†
CREATE TABLE saved_passengers (
  saved_passenger_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  full_name VARCHAR(100) NOT NULL,
  gender VARCHAR(20),
  nationality VARCHAR(50),
  document_type VARCHAR(50),
  document_number VARCHAR(50),
  date_of_birth DATE,
  relationship VARCHAR(50),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_saved_passengers_user ON saved_passengers(user_id);

-- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠØ©
CREATE TABLE schedules (
  schedule_id SERIAL PRIMARY KEY,
  partner_id BIGINT NOT NULL REFERENCES partners(partner_id) ON DELETE CASCADE,
  route_id BIGINT NOT NULL REFERENCES routes(route_id),
  schedule_name VARCHAR(150) NOT NULL,
  departure_time TIME NOT NULL,
  duration_minutes INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE schedule_recurrence_rules (
  rule_id SERIAL PRIMARY KEY,
  schedule_id INTEGER NOT NULL REFERENCES schedules(schedule_id) ON DELETE CASCADE,
  recurrence_type VARCHAR(20) CHECK (recurrence_type IN ('Daily', 'Weekly')),
  day_of_week SMALLINT CHECK (day_of_week BETWEEN 0 AND 6),
  start_date DATE NOT NULL,
  end_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
CREATE TABLE partner_settlements (
  settlement_id BIGSERIAL PRIMARY KEY,
  partner_id BIGINT NOT NULL REFERENCES partners(partner_id) ON DELETE CASCADE,
  amount NUMERIC NOT NULL,
  status VARCHAR(20) CHECK (status IN ('Pending', 'Paid', 'Failed')),
  period_start_date DATE NOT NULL,
  period_end_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  paid_at TIMESTAMPTZ,
  CONSTRAINT chk_partner_settlements_amount CHECK (amount >= 0)
);

CREATE INDEX idx_partner_settlements_partner ON partner_settlements(partner_id);
CREATE INDEX idx_partner_settlements_status ON partner_settlements(status);
```

### 6.2 Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 15)

```markdown
## Ù…Ù„Ù: docs/DATABASE_DOCUMENTATION.md

# ØªÙˆØ«ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª

## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ÙŠØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ Ø¬Ø¯Ø§ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ù„Ù‚ÙŠÙˆØ¯ØŒ ÙˆØ§Ù„Ø¯ÙˆØ§Ù„.

## Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### 1. users
**Ø§Ù„ÙˆØµÙ:** Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

| Ø§Ù„Ø¹Ù…ÙˆØ¯ | Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù‚ÙŠÙˆØ¯ |
|--------|------|-------|--------|
| user_id | BIGINT | Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ | PK, AUTO |
| auth_id | UUID | Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© | FK â†’ auth.users, UNIQUE |
| full_name | VARCHAR | Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ | NOT NULL |
| email | VARCHAR | Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ | UNIQUE |
| phone | VARCHAR | Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ | |

**Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª:**
- â† user_roles (one-to-many)
- â† bookings (one-to-many)
- â† saved_passengers (one-to-many)

### 2. bookings
**Ø§Ù„ÙˆØµÙ:** Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

[... ØªÙˆØ«ÙŠÙ‚ ØªÙØµÙŠÙ„ÙŠ Ù„ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ ...]

## Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

### get_current_user_id()
**Ø§Ù„ÙˆØµÙ:** Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ user_id Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
**Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
```sql
SELECT * FROM bookings WHERE user_id = get_current_user_id();
```

[... ØªÙˆØ«ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ ...]
```

### 6.3 Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 16)

```sql
-- Ù…Ù„Ù: tests/004_comprehensive_tests.sql

-- 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
DO $$
BEGIN
  -- ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Foreign Keys
  PERFORM 1 FROM information_schema.table_constraints
  WHERE constraint_type = 'FOREIGN KEY'
  HAVING COUNT(*) >= 40;
  
  -- ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Indexes
  PERFORM 1 FROM pg_indexes
  WHERE schemaname = 'public'
  HAVING COUNT(*) >= 50;
  
  RAISE NOTICE 'All comprehensive tests passed!';
END $$;

-- 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡
-- (ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ°Ù‡Ø§ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©)

-- 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù†
-- (ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø³ÙŠØ§Ø³Ø§Øª RLS)
```

---

## Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­

### Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (KPIs)

| Ø§Ù„Ù…Ø¤Ø´Ø± | Ø§Ù„Ù‡Ø¯Ù | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© |
|--------|-------|---------|
| **Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** | 100% (Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙŠÙ…Ø©) | Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ­Øµ ÙŠÙˆÙ…ÙŠØ© |
| **ÙˆÙ‚Øª Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª** | < 100ms Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© | pg_stat_statements |
| **ØªØºØ·ÙŠØ© RLS** | 100% Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø© | ÙØ­Øµ pg_policies |
| **ØªÙˆÙØ± Ø§Ù„Ù†Ø¸Ø§Ù…** | 99.9% | Ù…Ø±Ø§Ù‚Ø¨Ø© uptime |
| **Ø±Ø¶Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†** | > 4.5/5 | Ø§Ø³ØªØ·Ù„Ø§Ø¹Ø§Øª Ø¯ÙˆØ±ÙŠØ© |

### Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©

#### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- âœ… Ø¬Ù…ÙŠØ¹ Foreign Keys Ù…Ø¶Ø§ÙØ©
- âœ… Ø¬Ù…ÙŠØ¹ Unique Constraints Ù…Ø¶Ø§ÙØ©
- âœ… Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙŠÙ…Ø©
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ…Ø± Ø¨Ù†Ø¬Ø§Ø­

#### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø£Ø¯Ø§Ø¡
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø­Ø±Ø¬Ø© Ù…Ø¶Ø§ÙØ©
- âœ… ÙˆÙ‚Øª Ø§Ø³ØªØ¬Ø§Ø¨Ø© < 100ms
- âœ… ØªØ­Ø³ÙŠÙ† Ø³ÙŠØ§Ø³Ø§Øª RLS
- âœ… Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…ÙˆØ«Ù‚Ø©

#### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ø£Ù…Ø§Ù†
- âœ… RLS Ù…ÙØ¹Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ù…Ø®ØªØ¨Ø±Ø©
- âœ… Ù„Ø§ Ø«ØºØ±Ø§Øª Ø£Ù…Ù†ÙŠØ©
- âœ… ØªØ¯Ù‚ÙŠÙ‚ Ø£Ù…Ù†ÙŠ ÙƒØ§Ù…Ù„

---

## Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±

### Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©

| Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© | Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© | Ø§Ù„ØªØ£Ø«ÙŠØ± | Ø®Ø·Ø© Ø§Ù„ØªØ®ÙÙŠÙ |
|----------|------------|---------|--------------|
| **ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** | Ù…Ù†Ø®ÙØ¶ | Ø­Ø±Ø¬ | Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠÙˆÙ…ÙŠØ© + Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© |
| **ØªÙˆÙ‚Ù Ø§Ù„Ø®Ø¯Ù…Ø©** | Ù…ØªÙˆØ³Ø· | Ø¹Ø§Ù„ÙŠ | ØªÙ†ÙÙŠØ° ÙÙŠ ÙˆÙ‚Øª Ø§Ù„ØµÙŠØ§Ù†Ø© + Ø®Ø·Ø© Ø±Ø¬ÙˆØ¹ |
| **Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡** | Ù…ØªÙˆØ³Ø· | Ù…ØªÙˆØ³Ø· | Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© staging Ø£ÙˆÙ„Ø§Ù‹ |
| **ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** | Ù…Ù†Ø®ÙØ¶ | Ø¹Ø§Ù„ÙŠ | Ù‚ÙÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„ |
| **Ù†Ù‚Øµ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯** | Ù…ØªÙˆØ³Ø· | Ù…ØªÙˆØ³Ø· | ØªØ®Ø·ÙŠØ· Ù…Ø³Ø¨Ù‚ + ÙØ±ÙŠÙ‚ Ø§Ø­ØªÙŠØ§Ø·ÙŠ |

### Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦

```markdown
## ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„:

1. **Ø¥ÙŠÙ‚Ø§Ù ÙÙˆØ±ÙŠ** Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
2. **ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¶Ø±Ø±** ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±
3. **Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©** Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
4. **ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ**
5. **ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©** ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
6. **ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø©**
```

---

## Ø§Ù„Ø®Ù„Ø§ØµØ©

Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© ØªØ­ÙˆÙ„ Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª Ø¥Ù„Ù‰ Ù…Ù†ØµØ© **Ù…ØªÙƒØ§Ù…Ù„Ø©ØŒ Ø¢Ù…Ù†Ø©ØŒ ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ø¹** Ø®Ù„Ø§Ù„ **16 Ø£Ø³Ø¨ÙˆØ¹**.

### Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ù„Ø®Øµ:

| Ø§Ù„Ù…Ø±Ø­Ù„Ø© | Ø§Ù„Ù…Ø¯Ø© | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© |
|---------|-------|----------|-------------------|
| 0 | 1 Ø£Ø³Ø¨ÙˆØ¹ | ØªØ­Ø¶ÙŠØ±ÙŠ | Ø¨ÙŠØ¦Ø© Ø¬Ø§Ù‡Ø²Ø© + Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© |
| 1 | 2 Ø£Ø³Ø¨ÙˆØ¹ | ğŸ”´ Ø­Ø±Ø¬ | Ø³Ù„Ø§Ù…Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø© |
| 2 | 2 Ø£Ø³Ø¨ÙˆØ¹ | ğŸ”´ Ø­Ø±Ø¬ | Ø£Ø¯Ø§Ø¡ Ù…Ø­Ø³Ù‘Ù† |
| 3 | 1 Ø£Ø³Ø¨ÙˆØ¹ | ğŸ”´ Ø­Ø±Ø¬ | Ø£Ù…Ø§Ù† Ù…Ø¹Ø²Ø² |
| 4 | 4 Ø£Ø³Ø¨ÙˆØ¹ | ğŸŸ  Ø¹Ø§Ù„ÙŠ | Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© |
| 5 | 2 Ø£Ø³Ø¨ÙˆØ¹ | ğŸŸ¡ Ù…ØªÙˆØ³Ø· | Ù‚Ø§Ø¨Ù„ÙŠØ© ØªÙˆØ³Ø¹ |
| 6 | 4 Ø£Ø³Ø¨ÙˆØ¹ | ğŸŸ¢ Ù…Ù†Ø®ÙØ¶ | ØªÙˆØ«ÙŠÙ‚ + Ø§Ø®ØªØ¨Ø§Ø± |

### Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:

1. âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø®Ø·Ø© Ù…Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚
2. âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯
3. âœ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù…Ø±Ø­Ù„Ø© 0 (Ø§Ù„ØªØ­Ø¶ÙŠØ±)
4. âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
5. âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

**ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:** Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø­Ø§ÙÙ„Ø§Øª Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©!

---

**Ù†Ù‡Ø§ÙŠØ© Ø®Ø·Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø©**
