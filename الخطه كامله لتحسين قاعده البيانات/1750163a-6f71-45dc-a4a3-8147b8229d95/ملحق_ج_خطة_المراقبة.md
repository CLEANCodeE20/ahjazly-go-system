# ملحق ج: خطة المراقبة والتتبع
**الهدف:** مراقبة صحة وأداء النظام بعد كل مرحلة تحسين

---

## 1. مؤشرات الأداء الرئيسية (KPIs)

### 1.1 مؤشرات قاعدة البيانات

| المؤشر | الوصف | الحد الأدنى المقبول | الحد الأقصى المقبول |
|--------|-------|---------------------|---------------------|
| **متوسط وقت الاستعلام** | متوسط وقت تنفيذ الاستعلامات | - | < 100ms |
| **الاستعلامات البطيئة** | عدد الاستعلامات > 1 ثانية | - | < 10 في الساعة |
| **استخدام CPU** | نسبة استخدام المعالج | - | < 70% |
| **استخدام الذاكرة** | نسبة استخدام الذاكرة | - | < 80% |
| **حجم قاعدة البيانات** | الحجم الإجمالي | - | نمو < 10% شهرياً |
| **الاتصالات النشطة** | عدد الاتصالات المفتوحة | - | < 80% من الحد الأقصى |
| **معدل الأخطاء** | نسبة الاستعلامات الفاشلة | - | < 0.1% |

### 1.2 مؤشرات التطبيق

| المؤشر | الوصف | الحد الأدنى المقبول | الحد الأقصى المقبول |
|--------|-------|---------------------|---------------------|
| **وقت الاستجابة** | متوسط وقت استجابة API | - | < 200ms |
| **معدل النجاح** | نسبة الطلبات الناجحة | > 99.5% | - |
| **معدل الحجوزات** | عدد الحجوزات في الساعة | - | - |
| **معدل الدفع** | نسبة الدفعات الناجحة | > 98% | - |
| **الجلسات النشطة** | عدد المستخدمين النشطين | - | - |

---

## 2. أدوات المراقبة

### 2.1 مراقبة قاعدة البيانات

#### تفعيل pg_stat_statements

```sql
-- ملف: monitoring/001_enable_monitoring.sql

-- تفعيل الإضافة
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- إعداد المعاملات
ALTER SYSTEM SET pg_stat_statements.track = 'all';
ALTER SYSTEM SET pg_stat_statements.max = 10000;
ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_statements';

-- إعادة تحميل الإعدادات
SELECT pg_reload_conf();
```

#### إنشاء عروض المراقبة

```sql
-- ملف: monitoring/002_create_monitoring_views.sql

-- عرض الاستعلامات البطيئة
CREATE OR REPLACE VIEW slow_queries AS
SELECT 
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time,
  stddev_exec_time,
  rows
FROM pg_stat_statements
WHERE mean_exec_time > 100 -- أكثر من 100ms
ORDER BY mean_exec_time DESC
LIMIT 50;

-- عرض استخدام الفهارس
CREATE OR REPLACE VIEW index_usage AS
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch,
  pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;

-- عرض حجم الجداول
CREATE OR REPLACE VIEW table_sizes AS
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - 
                 pg_relation_size(schemaname||'.'||tablename)) as indexes_size,
  n_live_tup as row_count,
  n_dead_tup as dead_rows
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- عرض الاتصالات النشطة
CREATE OR REPLACE VIEW active_connections AS
SELECT 
  datname,
  usename,
  application_name,
  client_addr,
  state,
  query,
  state_change,
  NOW() - state_change as duration
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY state_change;

-- عرض معدل الأخطاء
CREATE OR REPLACE VIEW error_rate AS
SELECT 
  datname,
  xact_commit,
  xact_rollback,
  ROUND(xact_rollback::NUMERIC / NULLIF(xact_commit + xact_rollback, 0) * 100, 2) as rollback_percentage,
  conflicts,
  deadlocks
FROM pg_stat_database
WHERE datname = current_database();
```

### 2.2 جدول سجل المراقبة

```sql
-- ملف: monitoring/003_create_monitoring_log.sql

-- جدول لحفظ المقاييس التاريخية
CREATE TABLE monitoring_metrics (
  metric_id BIGSERIAL PRIMARY KEY,
  metric_name VARCHAR(100) NOT NULL,
  metric_value NUMERIC NOT NULL,
  metric_unit VARCHAR(20),
  threshold_min NUMERIC,
  threshold_max NUMERIC,
  is_within_threshold BOOLEAN GENERATED ALWAYS AS (
    (threshold_min IS NULL OR metric_value >= threshold_min) AND
    (threshold_max IS NULL OR metric_value <= threshold_max)
  ) STORED,
  recorded_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_monitoring_metrics_name_time 
  ON monitoring_metrics(metric_name, recorded_at DESC);

-- دالة لتسجيل المقاييس
CREATE OR REPLACE FUNCTION record_metric(
  p_metric_name VARCHAR,
  p_metric_value NUMERIC,
  p_metric_unit VARCHAR DEFAULT NULL,
  p_threshold_min NUMERIC DEFAULT NULL,
  p_threshold_max NUMERIC DEFAULT NULL
)
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO monitoring_metrics (
    metric_name, 
    metric_value, 
    metric_unit,
    threshold_min,
    threshold_max
  )
  VALUES (
    p_metric_name,
    p_metric_value,
    p_metric_unit,
    p_threshold_min,
    p_threshold_max
  );
END;
$$;
```

---

## 3. سكريبتات المراقبة الآلية

### 3.1 سكريبت المراقبة اليومية

```sql
-- ملف: monitoring/004_daily_monitoring.sql

DO $$
DECLARE
  avg_query_time NUMERIC;
  slow_query_count INTEGER;
  cpu_usage NUMERIC;
  memory_usage NUMERIC;
  db_size BIGINT;
  active_conn INTEGER;
  error_rate NUMERIC;
BEGIN
  -- 1. متوسط وقت الاستعلام
  SELECT AVG(mean_exec_time) INTO avg_query_time
  FROM pg_stat_statements;
  
  PERFORM record_metric(
    'Average Query Time',
    avg_query_time,
    'ms',
    NULL,
    100
  );
  
  -- 2. عدد الاستعلامات البطيئة
  SELECT COUNT(*) INTO slow_query_count
  FROM pg_stat_statements
  WHERE mean_exec_time > 1000;
  
  PERFORM record_metric(
    'Slow Queries Count',
    slow_query_count,
    'queries',
    NULL,
    10
  );
  
  -- 3. حجم قاعدة البيانات
  SELECT pg_database_size(current_database()) INTO db_size;
  
  PERFORM record_metric(
    'Database Size',
    db_size / (1024 * 1024 * 1024.0), -- تحويل لـ GB
    'GB',
    NULL,
    100
  );
  
  -- 4. الاتصالات النشطة
  SELECT COUNT(*) INTO active_conn
  FROM pg_stat_activity
  WHERE state != 'idle';
  
  PERFORM record_metric(
    'Active Connections',
    active_conn,
    'connections',
    NULL,
    80
  );
  
  -- 5. معدل الأخطاء
  SELECT 
    ROUND(xact_rollback::NUMERIC / NULLIF(xact_commit + xact_rollback, 0) * 100, 2)
  INTO error_rate
  FROM pg_stat_database
  WHERE datname = current_database();
  
  PERFORM record_metric(
    'Error Rate',
    error_rate,
    '%',
    NULL,
    0.1
  );
  
  RAISE NOTICE '✅ Daily monitoring completed';
END $$;
```

### 3.2 سكريبت تنبيهات الأداء

```sql
-- ملف: monitoring/005_performance_alerts.sql

CREATE OR REPLACE FUNCTION check_performance_alerts()
RETURNS TABLE (
  alert_type VARCHAR,
  alert_message TEXT,
  severity VARCHAR,
  current_value NUMERIC,
  threshold NUMERIC
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- تنبيه: استعلامات بطيئة
  RETURN QUERY
  SELECT 
    'Slow Queries'::VARCHAR,
    'Found ' || COUNT(*)::TEXT || ' queries slower than 1 second'::TEXT,
    'WARNING'::VARCHAR,
    COUNT(*)::NUMERIC,
    10::NUMERIC
  FROM pg_stat_statements
  WHERE mean_exec_time > 1000
  HAVING COUNT(*) > 10;
  
  -- تنبيه: اتصالات كثيرة
  RETURN QUERY
  SELECT 
    'High Connections'::VARCHAR,
    'Active connections: ' || COUNT(*)::TEXT::TEXT,
    'WARNING'::VARCHAR,
    COUNT(*)::NUMERIC,
    80::NUMERIC
  FROM pg_stat_activity
  WHERE state != 'idle'
  HAVING COUNT(*) > 80;
  
  -- تنبيه: جداول منتفخة
  RETURN QUERY
  SELECT 
    'Bloated Tables'::VARCHAR,
    'Table ' || tablename || ' has ' || n_dead_tup::TEXT || ' dead rows'::TEXT,
    'INFO'::VARCHAR,
    n_dead_tup::NUMERIC,
    10000::NUMERIC
  FROM pg_stat_user_tables
  WHERE n_dead_tup > 10000
  LIMIT 5;
  
  -- تنبيه: فهارس غير مستخدمة
  RETURN QUERY
  SELECT 
    'Unused Indexes'::VARCHAR,
    'Index ' || indexname || ' on ' || tablename || ' is not being used'::TEXT,
    'INFO'::VARCHAR,
    idx_scan::NUMERIC,
    100::NUMERIC
  FROM pg_stat_user_indexes
  WHERE idx_scan < 100
    AND indexname NOT LIKE '%_pkey'
  LIMIT 5;
END;
$$;

-- استدعاء دالة التنبيهات
SELECT * FROM check_performance_alerts();
```

---

## 4. لوحة المراقبة (Dashboard)

### 4.1 استعلامات لوحة المراقبة

```sql
-- ملف: monitoring/006_dashboard_queries.sql

-- 1. ملخص الأداء
CREATE OR REPLACE VIEW performance_summary AS
SELECT 
  (SELECT COUNT(*) FROM pg_stat_activity WHERE state != 'idle') as active_connections,
  (SELECT COUNT(*) FROM pg_stat_statements WHERE mean_exec_time > 1000) as slow_queries,
  (SELECT pg_size_pretty(pg_database_size(current_database()))) as database_size,
  (SELECT ROUND(AVG(mean_exec_time), 2) FROM pg_stat_statements) as avg_query_time_ms,
  (SELECT COUNT(*) FROM bookings WHERE created_at > NOW() - INTERVAL '1 hour') as bookings_last_hour,
  (SELECT COUNT(*) FROM users WHERE last_sign_in_at > NOW() - INTERVAL '1 hour') as active_users_last_hour;

-- 2. أفضل 10 استعلامات بطيئة
CREATE OR REPLACE VIEW top_slow_queries AS
SELECT 
  LEFT(query, 100) as query_preview,
  calls,
  ROUND(mean_exec_time::NUMERIC, 2) as avg_time_ms,
  ROUND(total_exec_time::NUMERIC, 2) as total_time_ms,
  ROUND((total_exec_time / SUM(total_exec_time) OVER ()) * 100, 2) as percentage_of_total
FROM pg_stat_statements
WHERE query NOT LIKE '%pg_stat%'
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. استخدام الجداول
CREATE OR REPLACE VIEW table_activity AS
SELECT 
  schemaname,
  tablename,
  seq_scan,
  idx_scan,
  n_tup_ins as inserts,
  n_tup_upd as updates,
  n_tup_del as deletes,
  n_live_tup as live_rows,
  n_dead_tup as dead_rows,
  ROUND((n_dead_tup::NUMERIC / NULLIF(n_live_tup, 0)) * 100, 2) as dead_row_percentage
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;

-- 4. نمو قاعدة البيانات (آخر 30 يوم)
CREATE OR REPLACE VIEW database_growth AS
SELECT 
  DATE(recorded_at) as date,
  AVG(metric_value) as avg_size_gb,
  MAX(metric_value) as max_size_gb
FROM monitoring_metrics
WHERE metric_name = 'Database Size'
  AND recorded_at > NOW() - INTERVAL '30 days'
GROUP BY DATE(recorded_at)
ORDER BY date DESC;
```

### 4.2 تقرير الحالة اليومي

```sql
-- ملف: monitoring/007_daily_health_report.sql

CREATE OR REPLACE FUNCTION generate_daily_health_report()
RETURNS TABLE (
  section VARCHAR,
  metric VARCHAR,
  value TEXT,
  status VARCHAR
)
LANGUAGE plpgsql
AS $$
BEGIN
  -- قسم الأداء
  RETURN QUERY
  SELECT 
    'Performance'::VARCHAR,
    'Average Query Time'::VARCHAR,
    ROUND(AVG(mean_exec_time), 2)::TEXT || ' ms'::TEXT,
    CASE 
      WHEN AVG(mean_exec_time) < 100 THEN '✅ Good'
      WHEN AVG(mean_exec_time) < 500 THEN '⚠️ Warning'
      ELSE '❌ Critical'
    END::VARCHAR
  FROM pg_stat_statements;
  
  -- قسم الموارد
  RETURN QUERY
  SELECT 
    'Resources'::VARCHAR,
    'Active Connections'::VARCHAR,
    COUNT(*)::TEXT,
    CASE 
      WHEN COUNT(*) < 50 THEN '✅ Good'
      WHEN COUNT(*) < 80 THEN '⚠️ Warning'
      ELSE '❌ Critical'
    END::VARCHAR
  FROM pg_stat_activity
  WHERE state != 'idle';
  
  -- قسم السلامة
  RETURN QUERY
  SELECT 
    'Integrity'::VARCHAR,
    'Error Rate'::VARCHAR,
    ROUND(xact_rollback::NUMERIC / NULLIF(xact_commit + xact_rollback, 0) * 100, 2)::TEXT || '%'::TEXT,
    CASE 
      WHEN xact_rollback::NUMERIC / NULLIF(xact_commit + xact_rollback, 0) < 0.001 THEN '✅ Good'
      WHEN xact_rollback::NUMERIC / NULLIF(xact_commit + xact_rollback, 0) < 0.01 THEN '⚠️ Warning'
      ELSE '❌ Critical'
    END::VARCHAR
  FROM pg_stat_database
  WHERE datname = current_database();
  
  -- قسم التخزين
  RETURN QUERY
  SELECT 
    'Storage'::VARCHAR,
    'Database Size'::VARCHAR,
    pg_size_pretty(pg_database_size(current_database())),
    '✅ Good'::VARCHAR;
END;
$$;

-- استدعاء التقرير
SELECT * FROM generate_daily_health_report();
```

---

## 5. التنبيهات التلقائية

### 5.1 إعداد التنبيهات

```sql
-- ملف: monitoring/008_setup_alerts.sql

-- جدول إعدادات التنبيهات
CREATE TABLE alert_settings (
  alert_id SERIAL PRIMARY KEY,
  alert_name VARCHAR(100) UNIQUE NOT NULL,
  metric_name VARCHAR(100) NOT NULL,
  threshold_value NUMERIC NOT NULL,
  comparison_operator VARCHAR(10) NOT NULL, -- '>', '<', '>=', '<=', '='
  severity VARCHAR(20) NOT NULL, -- 'INFO', 'WARNING', 'CRITICAL'
  notification_channels TEXT[], -- ['email', 'sms', 'slack']
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- إدراج تنبيهات افتراضية
INSERT INTO alert_settings (alert_name, metric_name, threshold_value, comparison_operator, severity, notification_channels) VALUES
('Slow Query Alert', 'Average Query Time', 500, '>', 'WARNING', ARRAY['email']),
('High Connection Alert', 'Active Connections', 80, '>', 'WARNING', ARRAY['email', 'sms']),
('Critical Error Rate', 'Error Rate', 1, '>', 'CRITICAL', ARRAY['email', 'sms', 'slack']),
('Database Size Alert', 'Database Size', 100, '>', 'INFO', ARRAY['email']);

-- جدول سجل التنبيهات
CREATE TABLE alert_log (
  log_id BIGSERIAL PRIMARY KEY,
  alert_id INTEGER REFERENCES alert_settings(alert_id),
  metric_value NUMERIC NOT NULL,
  threshold_value NUMERIC NOT NULL,
  severity VARCHAR(20) NOT NULL,
  message TEXT NOT NULL,
  is_resolved BOOLEAN DEFAULT FALSE,
  triggered_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ
);

CREATE INDEX idx_alert_log_triggered ON alert_log(triggered_at DESC);
CREATE INDEX idx_alert_log_unresolved ON alert_log(is_resolved) WHERE is_resolved = FALSE;
```

### 5.2 دالة فحص التنبيهات

```sql
-- ملف: monitoring/009_check_alerts.sql

CREATE OR REPLACE FUNCTION check_and_trigger_alerts()
RETURNS TABLE (
  alert_name VARCHAR,
  severity VARCHAR,
  message TEXT
)
LANGUAGE plpgsql
AS $$
DECLARE
  alert_record RECORD;
  current_value NUMERIC;
  should_trigger BOOLEAN;
BEGIN
  FOR alert_record IN 
    SELECT * FROM alert_settings WHERE is_active = TRUE
  LOOP
    -- الحصول على القيمة الحالية للمقياس
    SELECT metric_value INTO current_value
    FROM monitoring_metrics
    WHERE metric_name = alert_record.metric_name
    ORDER BY recorded_at DESC
    LIMIT 1;
    
    -- التحقق من تجاوز العتبة
    should_trigger := CASE alert_record.comparison_operator
      WHEN '>' THEN current_value > alert_record.threshold_value
      WHEN '<' THEN current_value < alert_record.threshold_value
      WHEN '>=' THEN current_value >= alert_record.threshold_value
      WHEN '<=' THEN current_value <= alert_record.threshold_value
      WHEN '=' THEN current_value = alert_record.threshold_value
      ELSE FALSE
    END;
    
    IF should_trigger THEN
      -- تسجيل التنبيه
      INSERT INTO alert_log (alert_id, metric_value, threshold_value, severity, message)
      VALUES (
        alert_record.alert_id,
        current_value,
        alert_record.threshold_value,
        alert_record.severity,
        alert_record.alert_name || ': ' || alert_record.metric_name || ' is ' || 
        current_value || ' (threshold: ' || alert_record.threshold_value || ')'
      );
      
      -- إرجاع التنبيه
      RETURN QUERY
      SELECT 
        alert_record.alert_name,
        alert_record.severity,
        alert_record.alert_name || ': ' || alert_record.metric_name || ' is ' || 
        current_value || ' (threshold: ' || alert_record.threshold_value || ')'::TEXT;
    END IF;
  END LOOP;
END;
$$;
```

---

## 6. جدول المراقبة بعد كل مرحلة

### 6.1 فترة المراقبة المكثفة (48 ساعة)

| الوقت | المهمة | المسؤول |
|-------|--------|---------|
| **كل 15 دقيقة** | فحص الأداء والأخطاء | نظام آلي |
| **كل ساعة** | مراجعة السجلات | مهندس النظام |
| **كل 6 ساعات** | تقرير الحالة | مدير المشروع |
| **بعد 24 ساعة** | تقييم شامل | الفريق الكامل |
| **بعد 48 ساعة** | قرار الاستمرار | الإدارة |

### 6.2 قائمة التحقق اليومية

```markdown
## المراقبة اليومية (أول 7 أيام بعد كل مرحلة)

### الصباح (9 صباحاً):
- [ ] مراجعة تقرير الحالة اليومي
- [ ] فحص التنبيهات الليلية
- [ ] مراجعة الاستعلامات البطيئة
- [ ] فحص استخدام الموارد

### الظهر (1 ظهراً):
- [ ] مراجعة معدل الحجوزات
- [ ] فحص معدل نجاح الدفع
- [ ] مراجعة شكاوى المستخدمين

### المساء (6 مساءً):
- [ ] مراجعة ذروة الاستخدام
- [ ] فحص الأداء تحت الضغط
- [ ] تحديث تقرير الحالة

### الليل (11 مساءً):
- [ ] النسخ الاحتياطي اليومي
- [ ] تنظيف السجلات القديمة
- [ ] جدولة مهام الصيانة
```

---

## 7. معايير النجاح

### 7.1 بعد كل مرحلة

- [ ] جميع المقاييس ضمن النطاق المقبول لمدة 48 ساعة
- [ ] لا توجد تنبيهات حرجة
- [ ] الأداء مستقر أو محسّن
- [ ] لا توجد شكاوى مستخدمين متعلقة بالتحسين
- [ ] معدل الأخطاء < 0.1%

### 7.2 بعد اكتمال جميع المراحل

- [ ] تحسين الأداء بنسبة ≥ 50%
- [ ] استقرار النظام لمدة 30 يوم
- [ ] رضا المستخدمين ≥ 95%
- [ ] جميع الاختبارات ناجحة
- [ ] التوثيق مكتمل

---

## ✅ قائمة التحقق النهائية

- [ ] جميع أدوات المراقبة مثبتة ومفعلة
- [ ] لوحة المراقبة جاهزة ومتاحة
- [ ] التنبيهات مضبوطة ومختبرة
- [ ] فريق المراقبة مدرب ومستعد
- [ ] تقارير يومية تُرسل تلقائياً
- [ ] خطة الاستجابة للتنبيهات موثقة
